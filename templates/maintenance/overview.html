{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <div class="page-inner">
    
    <!-- ==================== PREMIUM PAGE HEADER - SUCCESS THEME (GREEN FOR MAINTENANCE) ==================== -->
    <div class="premium-page-header theme-success">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div class="d-flex align-items-center">
          <div class="premium-page-icon">
            <i class="fa fa-tools"></i>
          </div>
          <div class="ms-3">
            <h4 class="premium-page-title mb-0">Preventive Maintenance Overview</h4>
            <p class="text-white mb-0" style="font-size: 0.875rem; opacity: 0.9;">
              Track and manage scheduled PM assignments
            </p>
          </div>
        </div>
        
        <div class="premium-action-buttons mt-3 mt-md-0">
          <button class="premium-btn premium-btn-add" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
            <i class="fa fa-plus"></i>
            Assign Device
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== ADD SCHEDULE MODAL ==================== -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <form method="POST" action="{% url 'assign_pm_schedule' %}">
          {% csrf_token %}
          <div class="modal-content" style="border-radius: 20px; border: none;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 20px 20px 0 0; border: none;">
              <h5 class="modal-title text-white fw-bold">
                <i class="fa fa-calendar-plus me-2"></i>
                Assign Device to Schedule
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
              
              <!-- Device Type -->
              <div class="mb-4">
                <label class="form-label fw-semibold">
                  <i class="fa fa-desktop me-1 text-primary"></i>
                  Device Type
                </label>
                <select id="deviceTypeSelect" class="form-select" name="device_type" required style="border-radius: 10px; padding: 0.75rem;">
                  <option value="">-- Select Type --</option>
                  <option value="desktop">üñ•Ô∏è Desktop</option>
                  <option value="laptop">üíª Laptop</option>
                </select>
              </div>

              <!-- Desktop Dropdown -->
              <div class="mb-4 device-select" id="desktopWrapper" style="display:none;">
                <label class="form-label fw-semibold">
                  <i class="fa fa-desktop me-1 text-primary"></i>
                  Desktop Package
                </label>
                <select id="desktopSelect" class="form-select" name="equipment_package_id" style="border-radius: 10px; padding: 0.75rem;">
                  <option value="">-- Select Desktop --</option>
                  {% for d in desktops %}
                    {% if d.enduser_name and d.section_name %}
                      <option value="{{ d.id }}" data-section="{{ d.section_name }}">
                        {{ d.computer_name_display }} ‚Äî {{ d.enduser_name }} ‚Äî {{ d.section_name }}
                      </option>
                    {% else %}
                      <option value="{{ d.id }}">
                        {{ d.computer_name_display|default:"[No Computer Name]" }}
                      </option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>

              <!-- Laptop Dropdown -->
              <div class="mb-4 device-select" id="laptopWrapper" style="display:none;">
                <label class="form-label fw-semibold">
                  <i class="fa fa-laptop me-1 text-info"></i>
                  Laptop Package
                </label>
                <select id="laptopSelect" class="form-select" name="laptop_package_id" style="border-radius: 10px; padding: 0.75rem;">  
                  <option value="">-- Select Laptop --</option>
                  {% for l in laptops %}
                    {% if l.enduser_name and l.section_name %}
                      <option value="{{ l.id }}" data-section="{{ l.section_name }}">
                        {{ l.computer_name_display }} ‚Äî {{ l.enduser_name }} ‚Äî {{ l.section_name }}
                      </option>
                    {% else %}
                      <option value="{{ l.id }}">
                        {{ l.computer_name_display|default:"[No Computer Name]" }}
                      </option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>

              <!-- Schedule -->
              <div class="mb-4">
                <label class="form-label fw-semibold">
                  <i class="fa fa-calendar-check me-1 text-success"></i>
                  PM Schedule
                </label>
                <select id="scheduleSelect" class="form-select" name="schedule_id" required style="border-radius: 10px; padding: 0.75rem;">
                  <option value="">-- Select Schedule --</option>
                  {% for s in schedules %}
                    <option value="{{ s.id }}"
                            data-section="{{ s.section.name }}"
                            data-quarter="{{ s.quarter_schedule.id }}">
                      {{ s.section.name }} ‚Äî {{ s.quarter_schedule.get_quarter_display }} {{ s.quarter_schedule.year }} - (PM Schedule)
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="modal-footer" style="border: none; padding: 1.5rem 2rem;">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 50px; padding: 0.625rem 1.5rem;">
                <i class="fa fa-times me-1"></i> Cancel
              </button>
              <button type="submit" class="btn btn-success" style="border-radius: 50px; padding: 0.625rem 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
                <i class="fa fa-check me-1"></i> Assign Device
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ==================== PREMIUM TABLE CARD ==================== -->
    <div class="row">
      <div class="col-12">
        <div class="premium-table-card">
          <div class="premium-table-wrapper">
            
            <!-- Messages Handler -->
            {% if messages %}
            <script>
              $(document).ready(function () {
                {% for message in messages %}
                  $.notify({
                    message: "{{ message|escapejs }}",
                    title: "{% if message.tags == 'success' %}Success{% elif message.tags == 'error' %}Error{% elif message.tags == 'warning' %}Warning{% else %}Notice{% endif %}",
                    icon: "{% if message.tags == 'success' %}fa fa-check{% elif message.tags == 'error' %}fa fa-times{% elif message.tags == 'warning' %}fa fa-exclamation{% else %}fa fa-info{% endif %}"
                  }, {
                    type: "{{ message.tags }}",
                    placement: { from: "bottom", align: "right" },
                    delay: 4000,
                    z_index: 9999
                  });
                {% endfor %}
              });
            </script>
            {% endif %}
            
            <!-- DataTable -->
            <div class="table-responsive">
              <table id="pm-table" class="premium-datatable display" style="width:100%">
                <thead>
                  <!-- Header Row -->
                  <tr>
                    <th>Quarter</th>
                    <th>Section</th>
                    <th>Computer Name</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                  
                  <!-- Filter Row -->
                  <tr class="filters">
                    <th>
                      <input type="text" 
                             class="form-control form-control-sm column-search" 
                             placeholder="Search Quarter" 
                             data-column="0" />
                    </th>
                    <th>
                      <input type="text" 
                             class="form-control form-control-sm column-search" 
                             placeholder="Search Section" 
                             data-column="1" />
                    </th>
                    <th>
                      <input type="text" 
                             class="form-control form-control-sm column-search" 
                             placeholder="Search Computer" 
                             data-column="2" />
                    </th>
                    <th>
                      <input type="text" 
                             class="form-control form-control-sm column-search" 
                             placeholder="Search Start" 
                             data-column="3" />
                    </th>
                    <th>
                      <input type="text" 
                             class="form-control form-control-sm column-search" 
                             placeholder="Search End" 
                             data-column="4" />
                    </th>
                    <th>
                      <select class="form-select form-select-sm column-search" 
                              data-column="5">
                        <option value="">All Status</option>
                        <option value="Completed">Completed</option>
                        <option value="Due">Due</option>
                        <option value="Pending">Pending</option>
                      </select>
                    </th>
                    <th></th>
                  </tr>
                </thead>
                
                <tbody>
                  {% for assignment in pm_assignments %}
                  <tr class="clickable-row"
                      {% if assignment.equipment_package %}
                        data-href="{% url 'maintenance_history' assignment.equipment_package.id %}"
                      {% elif assignment.laptop_package %}
                        data-href="{% url 'maintenance_history_laptop' assignment.laptop_package.id %}"
                      {% endif %}
                      style="cursor: pointer;">
                    <td>
                      {% with quarter=assignment.pm_section_schedule.quarter_schedule.get_quarter_display %}
                        {% if quarter == "Q1" or quarter == "1st Quarter" %}
                          <span class="badge" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 0.5rem 0.875rem; border-radius: 50px; font-weight: 600; font-size: 0.75rem;">
                            <i class="fa fa-calendar me-1"></i>{{ quarter }} {{ assignment.pm_section_schedule.quarter_schedule.year }}
                          </span>
                        {% elif quarter == "Q2" or quarter == "2nd Quarter" %}
                          <span class="badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 0.5rem 0.875rem; border-radius: 50px; font-weight: 600; font-size: 0.75rem;">
                            <i class="fa fa-calendar me-1"></i>{{ quarter }} {{ assignment.pm_section_schedule.quarter_schedule.year }}
                          </span>
                        {% elif quarter == "Q3" or quarter == "3rd Quarter" %}
                          <span class="badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.5rem 0.875rem; border-radius: 50px; font-weight: 600; font-size: 0.75rem;">
                            <i class="fa fa-calendar me-1"></i>{{ quarter }} {{ assignment.pm_section_schedule.quarter_schedule.year }}
                          </span>
                        {% elif quarter == "Q4" or quarter == "4th Quarter" %}
                          <span class="badge" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 0.5rem 0.875rem; border-radius: 50px; font-weight: 600; font-size: 0.75rem;">
                            <i class="fa fa-calendar me-1"></i>{{ quarter }} {{ assignment.pm_section_schedule.quarter_schedule.year }}
                          </span>
                        {% else %}
                          <span class="badge" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; padding: 0.5rem 0.875rem; border-radius: 50px; font-weight: 600; font-size: 0.75rem;">
                            <i class="fa fa-calendar me-1"></i>{{ quarter }} {{ assignment.pm_section_schedule.quarter_schedule.year }}
                          </span>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td>
                      <span class="fw-semibold text-dark">
                        <i class="fa fa-building text-primary me-1" style="font-size: 12px;"></i>
                        {{ assignment.pm_section_schedule.section.name }}
                      </span>
                    </td>
                    <td>
                      <span class="fw-bold text-dark">{{ assignment.computer_name_display }}</span>
                    </td>
                    <td>
                      <span class="text-muted" style="font-size: 0.875rem;">
                        <i class="fa fa-calendar-day text-success me-1" style="font-size: 11px;"></i>
                        {{ assignment.pm_section_schedule.start_date|date:"M d, Y" }}
                      </span>
                    </td>
                    <td>
                      <span class="text-muted" style="font-size: 0.875rem;">
                        <i class="fa fa-calendar-times text-danger me-1" style="font-size: 11px;"></i>
                        {{ assignment.pm_section_schedule.end_date|date:"M d, Y" }}
                      </span>
                    </td>
                    <td>
                      {% if assignment.is_completed %}
                        <span class="premium-status-badge" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;">
                          <i class="fa fa-check-circle"></i>
                          Completed
                        </span>
                      {% elif assignment.is_due %}
                        <span class="premium-status-badge" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b;">
                          <i class="fa fa-exclamation-circle"></i>
                          Due
                        </span>
                      {% else %}
                        <span class="premium-status-badge" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                          <i class="fa fa-clock"></i>
                          Pending
                        </span>
                      {% endif %}
                    </td>
                    <td>
                      {% if assignment.equipment_package %}
                        <a href="{% url 'maintenance_history' assignment.equipment_package.id %}" class="premium-view-btn theme-success">
                          <i class="fa fa-eye"></i> View
                        </a>
                      {% elif assignment.laptop_package %}
                        <a href="{% url 'maintenance_history_laptop' assignment.laptop_package.id %}" class="premium-view-btn theme-success">
                          <i class="fa fa-eye"></i> View
                        </a>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="7" class="text-center py-5">
                      <div style="opacity: 0.5;">
                        <i class="fa fa-tools fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No PM assignments available</p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
$(document).ready(function() {
  console.log('Initializing Premium PM Overview DataTable...');
  
  // Initialize DataTable
  var table = $('#pm-table').DataTable({
    orderCellsTop: true,
    fixedHeader: false,
    pageLength: 10,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
    language: {
      lengthMenu: "Show _MENU_ entries",
      info: "Showing _START_ to _END_ of _TOTAL_ assignments",
      infoEmpty: "Showing 0 to 0 of 0 assignments",
      infoFiltered: "(filtered from _MAX_ total assignments)",
      zeroRecords: "No matching assignments found",
      emptyTable: "No PM assignments available",
      paginate: {
        first: '<i class="fa fa-angle-double-left"></i>',
        last: '<i class="fa fa-angle-double-right"></i>',
        next: '<i class="fa fa-angle-right"></i>',
        previous: '<i class="fa fa-angle-left"></i>'
      }
    },
    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
    initComplete: function() {
      console.log('Premium PM Overview DataTable initialized successfully');
      
      // Add animation to rows
      $('#pm-table tbody tr').each(function(index) {
        $(this).css({
          'animation': 'fadeInUp 0.5s ease-out',
          'animation-delay': (index * 0.05) + 's',
          'animation-fill-mode': 'both'
        });
      });
    }
  });
  
  console.log('DataTable initialized');
  
  // Apply the search using data-column attribute
  $('.column-search').on('keyup change', function() {
    var columnIndex = $(this).data('column');
    var searchValue = this.value;
    
    console.log('Searching column ' + columnIndex + ' for: ' + searchValue);
    
    table.column(columnIndex).search(searchValue).draw();
  });
  
  // Add clear filters button
  $('.premium-action-buttons').append(
    '<button class="premium-btn" style="background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3);" id="clearFilters">' +
    '<i class="fa fa-times"></i> Clear Filters' +
    '</button>'
  );
  
  $('#clearFilters').on('click', function() {
    $('.column-search').val('');
    table.columns().search('').draw();
    console.log('All filters cleared');
  });
  
  console.log('Filter handlers attached');

  // Device type toggle
  $('#deviceTypeSelect').on('change', function() {
    $('.device-select').hide().find('select').prop('required', false);
    if (this.value === 'desktop') {
      $('#desktopWrapper').show().find('select').prop('required', true);
    }
    if (this.value === 'laptop') {
      $('#laptopWrapper').show().find('select').prop('required', true);
    }
    $('#scheduleSelect').val('');
    $('#scheduleSelect option').show();
  });

  // Clickable table rows
  $('.clickable-row').on('click', function(e) {
    // Don't navigate if clicking on a button or link
    if ($(e.target).closest('a, button').length) return;
    
    const href = $(this).data('href');
    if (href) window.location.href = href;
  });

  // --- Assigned quarters from backend ---
  let assignedQuarters = {};
  try {
    assignedQuarters = JSON.parse('{{ assigned_quarters_by_device_json|escapejs }}');
  } catch (e) {
    console.error('assigned_quarters_by_device_json parse error:', e);
    assignedQuarters = {};
  }

  // Filter schedules when picking a device
  function filterSchedules(deviceType, deviceId, selectedSection) {
    const key = deviceType + '-' + deviceId;
    const assignedForDevice = (assignedQuarters[key] || []).map(String);

    $('#scheduleSelect option').each(function() {
      const $opt = $(this);
      if ($opt.val() === '') {
        $opt.show();
        return;
      }

      const scheduleSection = ($opt.data('section') || '').trim();
      const quarterId = String($opt.data('quarter') || '');

      let hide = false;

      // hide if section mismatch
      if (selectedSection && scheduleSection && scheduleSection !== selectedSection) {
        hide = true;
      }

      // hide if this quarter already assigned to this device
      if (deviceId && quarterId && assignedForDevice.includes(quarterId)) {
        hide = true;
      }

      $opt.toggle(!hide);
    });

    $('#scheduleSelect').val('');
  }

  $('#desktopSelect').on('change', function() {
    const id = $(this).val();
    const section = ($(this).find(':selected').data('section') || '').trim();
    filterSchedules('desktop', id, section);
  });

  $('#laptopSelect').on('change', function() {
    const id = $(this).val();
    const section = ($(this).find(':selected').data('section') || '').trim();
    filterSchedules('laptop', id, section);
  });
});

// Add fade-in animation keyframes
if (!document.querySelector('#fadeInUpKeyframes')) {
  var style = document.createElement('style');
  style.id = 'fadeInUpKeyframes';
  style.textContent = `
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  `;
  document.head.appendChild(style);
}
</script>

<script>
$(document).ready(function() {
  // ‚úÖ FLOAT SUCCESS TOAST + CLOSE MODAL AFTER SUCCESS
  {% if messages %}
    {% for message in messages %}
      {% if message.tags == 'success' %}
        // Close the modal if open
        $('#addScheduleModal').modal('hide');

        // Floating success notification
        $.notify({
          title: '<strong><i class="fa fa-check me-1"></i>Success</strong><br>',
          message: "{{ message|escapejs }}"
        }, {
          type: 'success',
          placement: {
            from: "bottom",
            align: "right"
          },
          delay: 3500,
          allow_dismiss: true,
          z_index: 2000,
          animate: {
            enter: 'animated fadeInRight',
            exit: 'animated fadeOutRight'
          }
        });
      {% elif message.tags == 'error' %}
        $.notify({
          title: '<strong><i class="fa fa-times me-1"></i>Error</strong><br>',
          message: "{{ message|escapejs }}"
        }, {
          type: 'danger',
          placement: { from: "bottom", align: "right" },
          delay: 4000,
          z_index: 2000
        });
      {% elif message.tags == 'warning' %}
        $.notify({
          title: '<strong><i class="fa fa-exclamation me-1"></i>Warning</strong><br>',
          message: "{{ message|escapejs }}"
        }, {
          type: 'warning',
          placement: { from: "bottom", align: "right" },
          delay: 4000,
          z_index: 2000
        });
      {% endif %}
    {% endfor %}
  {% endif %}
});
</script>
{% endblock %}