{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block content %}
{% now "Y-m-d" as today %}

<div class="container">
  <div class="page-inner py-4">

    <!-- ==================== PREMIUM DETAIL PAGE HEADER ==================== -->
    <div class="premium-page-header">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div class="d-flex align-items-center">
          <div class="premium-detail-icon">
            <i class="fas fa-wrench"></i>
          </div>
          <div class="ms-3">
            <h3 class="premium-detail-title mb-1">Workstation Preventive Maintenance</h3>
            <p class="premium-detail-subtitle mb-0 text-white">Comprehensive maintenance tracking and schedule management</p>
          </div>
        </div>
        <div class="mt-3 mt-md-0">
          <a href="{% url 'checklist' desktop.id %}" class="premium-detail-btn primary">
            <i class="fa fa-plus me-1"></i> Conduct Maintenance
          </a>
        </div>
      </div>
    </div>

    <!-- ==================== WORKSTATION INFO CARD ==================== -->
    {% if desktop_details %}
    <div class="premium-info-card gradient-primary">
      <div class="premium-info-header">
        <div class="premium-info-icon-badge">
          <i class="fa fa-desktop"></i>
        </div>
        <div>
          <h4 class="premium-info-title">{{ desktop_details.computer_name }}</h4>
          <p class="premium-info-subtitle">Workstation Details</p>
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-md-4 col-lg-3">
          <div class="premium-info-item">
            <span class="premium-info-label">Brand</span>
            <span class="premium-info-value">{{ desktop_details.brand_name }}</span>
          </div>
        </div>
        <div class="col-md-4 col-lg-3">
          <div class="premium-info-item">
            <span class="premium-info-label">Model</span>
            <span class="premium-info-value">{{ desktop_details.model }}</span>
          </div>
        </div>
        <div class="col-md-4 col-lg-3">
          <div class="premium-info-item">
            <span class="premium-info-label">Serial Number</span>
            <span class="premium-info-value monospace">{{ desktop_details.serial_no }}</span>
          </div>
        </div>
        <div class="col-md-4 col-lg-3">
          <div class="premium-info-item">
            <span class="premium-info-label">Processor</span>
            <span class="premium-info-value">{{ desktop_details.processor }}</span>
          </div>
        </div>
        <div class="col-md-4 col-lg-3">
          <div class="premium-info-item">
            <span class="premium-info-label">Memory</span>
            <span class="premium-info-value">{{ desktop_details.memory }}</span>
          </div>
        </div>
        <div class="col-md-4 col-lg-3">
          <div class="premium-info-item">
            <span class="premium-info-label">Storage Drive</span>
            <span class="premium-info-value">{{ desktop_details.drive }}</span>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row g-4 mt-2">
      <!-- ==================== USER INFORMATION CARD ==================== -->
      {% if user_details %}
      <div class="col-lg-6">
        <div class="premium-info-card gradient-success h-100">
          <div class="premium-info-header">
            <div class="premium-info-icon-badge success">
              <i class="fa fa-user-circle"></i>
            </div>
            <h5 class="premium-info-title">User Information</h5>
          </div>

          <div class="premium-user-items">
            <div class="premium-user-item">
              <div>
                <span class="premium-user-label">End User</span>
                <span class="premium-user-value">{{ user_details.user_Enduser.full_name|default:"Not Assigned" }}</span>
              </div>
              <i class="fa fa-user"></i>
            </div>
            <div class="premium-user-item">
              <div>
                <span class="premium-user-label">Asset Owner</span>
                <span class="premium-user-value">{{ user_details.user_Assetowner.full_name|default:"Not Assigned" }}</span>
              </div>
              <i class="fa fa-user-tie"></i>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- ==================== CURRENT SCHEDULE CARD ==================== -->
      {% if current_pm_schedule %}
      <div class="col-lg-6">
        <div class="premium-info-card gradient-warning h-100">
          <div class="premium-info-header">
            <div class="premium-info-icon-badge warning">
              <i class="fa fa-calendar-check"></i>
            </div>
            <h5 class="premium-info-title">Current PM Schedule</h5>
          </div>

          <div class="premium-schedule-list">
            {% for schedule in current_pm_schedule %}
            <div class="premium-schedule-item {% if schedule.is_completed %}completed{% elif schedule.is_overdue %}overdue{% else %}pending{% endif %}">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="premium-schedule-title">{{ schedule.pm_section_schedule.quarter_schedule.get_quarter_display }} {{ schedule.pm_section_schedule.quarter_schedule.year }}</h6>
                  <p class="premium-schedule-section">{{ schedule.pm_section_schedule.section.name }}</p>
                </div>
                {% if schedule.is_completed %}
                  <span class="premium-schedule-badge completed">
                    <i class="fa fa-check-circle me-1"></i>Completed
                  </span>
                {% elif schedule.is_overdue %}
                  <span class="premium-schedule-badge overdue">
                    <i class="fa fa-exclamation-circle me-1"></i>Overdue
                  </span>
                {% else %}
                  <span class="premium-schedule-badge pending">
                    <i class="fa fa-clock me-1"></i>Pending
                  </span>
                {% endif %}
              </div>
              <div class="premium-schedule-dates">
                <span>
                  <i class="fa fa-calendar-check me-1"></i>
                  {{ schedule.pm_section_schedule.start_date|date:"M d, Y" }}
                </span>
                <span>
                  <i class="fa fa fa-calendar-check me-1"></i>
                  {{ schedule.pm_section_schedule.end_date|date:"M d, Y" }}
                </span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- ==================== MAINTENANCE HISTORY TABLE ==================== -->
    <div class="premium-info-card gradient-secondary mt-4">
      <div class="premium-info-header">
        <div class="premium-info-icon-badge secondary">
          <i class="fa fa-history"></i>
        </div>
        <div>
          <h5 class="premium-info-title">Maintenance History</h5>
          <p class="premium-info-subtitle">Complete record of all maintenance activities</p>
        </div>
      </div>

      {% if maintenance_records %}
      <div class="table-responsive mt-3">
        <table class="premium-history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Office</th>
              <th>Quarter</th>
              <th>Tasks Completed</th>
              <th class="text-center">Report</th>
            </tr>
          </thead>
          <tbody>
            {% for record in maintenance_records %}
            <tr>
              <td>
                <div class="premium-history-date">
                  <div class="premium-history-date-icon">
                    <i class="far fa-calendar-alt"></i>
                  </div>
                  <span>{{ record.date_accomplished|date:"M d, Y" }}</span>
                </div>
              </td>
              <td>
                <span class="premium-history-office">{{ record.office }}</span>
              </td>
              <td>
                {% if record.pm_schedule_assignment and record.pm_schedule_assignment.pm_section_schedule %}
                  <span class="premium-history-quarter">
                    <i class="fa fa-calendar-check me-1"></i>
                    {{ record.pm_schedule_assignment.pm_section_schedule.quarter_schedule.get_quarter_display }}
                    {{ record.pm_schedule_assignment.pm_section_schedule.quarter_schedule.year }}
                  </span>
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
              <td>
                <div class="premium-task-badges">
                  {% for i in "123456789"|make_list %}
                    {% with task_field="task_"|add:i note_field="note_"|add:i %}
                      {% if record|get_attr:task_field %}
                        <span class="premium-task-badge completed" 
                              data-bs-toggle="tooltip" 
                              {% with note=record|get_attr:note_field %}
                                {% if note %}title="{{ note }}"{% endif %}
                              {% endwith %}>
                          <i class="fa fa-check-circle me-1"></i>Task {{ i }}
                        </span>
                      {% else %}
                        <span class="premium-task-badge incomplete">
                          <i class="fa fa-times-circle me-1"></i>Task {{ i }}
                        </span>
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                </div>
              </td>
              <td class="text-center">
                <a href="{% url 'generate_pm_pdf' record.id %}" 
                   class="premium-pdf-btn"
                   data-bs-toggle="tooltip" 
                   title="Download PDF Report">
                  <i class="fa fa-file-pdf me-1"></i>PDF
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="premium-alert warning">
        <div class="premium-alert-icon">
          <i class="fa fa-exclamation-triangle"></i>
        </div>
        <div>
          <h6 class="premium-alert-title">No Maintenance Records</h6>
          <p class="premium-alert-text">No preventive maintenance history has been recorded for this workstation yet.</p>
        </div>
      </div>
      {% endif %}
    </div>

  </div>
</div>

<script>
  // Initialize Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>

{% endblock %}