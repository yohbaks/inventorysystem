{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <div class="page-inner">
    
    <!-- ==================== PREMIUM PAGE HEADER - PM SCHEDULE THEME (PURPLE) ==================== -->
    <div class="premium-page-header theme-desktop">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div class="d-flex align-items-center">
          <div class="premium-page-icon">
            <i class="fa fa-calendar-check"></i>
          </div>
          <div class="ms-3">
            <h4 class="premium-page-title mb-0">ðŸ“… Preventive Maintenance Schedules</h4>
            <p class="text-white mb-0" style="font-size: 0.875rem; opacity: 0.9;">
              Manage section-wise maintenance scheduling
            </p>
          </div>
        </div>
        
        <div class="premium-action-buttons mt-3 mt-md-0">
          <a href="#" class="premium-btn premium-btn-export" id="exportBtn">
            <i class="fas fa-download"></i>
            Export Excel
          </a>
          <a href="#" class="premium-btn premium-btn-print" onclick="window.print(); return false;">
            <i class="fas fa-print"></i>
            Print
          </a>
          <button class="premium-btn premium-btn-add" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
            <i class="fas fa-plus"></i>
            Add Schedule
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== PREMIUM INFO NOTE ==================== -->
    <div class="premium-info-note mt-3 mb-4 p-3">
      <div class="d-flex align-items-start">
        <div class="note-icon me-3">
          <i class="fas fa-info-circle"></i>
        </div>
        <div>
          <h6 class="mb-1 fw-semibold">Quick Guide</h6>
          <p class="mb-0">
            Use the <strong>search filters</strong> below each column to find specific schedules. 
            Click column headers to <strong>sort</strong>. View <strong>status badges</strong> to see upcoming, active, or completed schedules.
          </p>
        </div>
      </div>
    </div>

    <!-- Add Schedule Modal -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <form method="POST" action="{% url 'section_schedule_list' %}">
          {% csrf_token %}
          <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              <h5 class="modal-title" id="addScheduleModalLabel">
                <i class="fas fa-plus-circle me-2"></i>Add New Schedule
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-calendar me-2 text-primary"></i>Quarter
                </label>
                <select class="form-select" name="quarter_schedule_id" required>
                  <option value="">Select Quarter</option>
                  {% for quarter in quarters %}
                  <option value="{{ quarter.id }}">{{ quarter.get_quarter_display }} {{ quarter.year }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-building me-2 text-primary"></i>Office Section
                </label>
                <select class="form-select" name="section_id" required>
                  <option value="">Select Section</option>
                  {% for section in sections %}
                  <option value="{{ section.id }}">{{ section.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-calendar-day me-2 text-primary"></i>Start Date
                </label>
                <input type="date" class="form-control" name="start_date" required>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-calendar-check me-2 text-primary"></i>End Date
                </label>
                <input type="date" class="form-control" name="end_date" required>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-sticky-note me-2 text-primary"></i>Notes (Optional)
                </label>
                <textarea class="form-control" name="notes" rows="3" placeholder="Add any additional notes..."></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Save Schedule
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ==================== PREMIUM TABLE CARD ==================== -->
    <div class="row">
      <div class="col-12">
        <div class="premium-table-card">
          <div class="premium-table-wrapper">
            
            <!-- DataTable -->
            <div class="table-responsive">
              <table id="schedule-table" class="premium-datatable display" style="width:100%">
                <thead>
                  <!-- Header Row -->
                  <tr>
                    <th>Quarter</th>
                    <th>Year</th>
                    <th>Section</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Duration</th>
                    <th>Status</th>
                    <th>Notes</th>
                  </tr>
                  
                  <!-- Filter Row -->
                  <tr class="filters">
                    <th>
                      <select class="form-select form-select-sm column-search" data-column="0">
                        <option value="">All Quarters</option>
                        <option value="1st Quarter">1st Quarter</option>
                        <option value="2nd Quarter">2nd Quarter</option>
                        <option value="3rd Quarter">3rd Quarter</option>
                        <option value="4th Quarter">4th Quarter</option>
                      </select>
                    </th>
                    <th>
                      <select class="form-select form-select-sm column-search" data-column="1">
                        <option value="">All Years</option>
                        {% for schedule in schedules %}
                          <option value="{{ schedule.quarter_schedule.year }}">{{ schedule.quarter_schedule.year }}</option>
                        {% endfor %}
                      </select>
                    </th>
                    <th>
                      <select class="form-select form-select-sm column-search" data-column="2">
                        <option value="">All Sections</option>
                        {% for section in sections %}
                          <option value="{{ section.name }}">{{ section.name }}</option>
                        {% endfor %}
                      </select>
                    </th>
                    <th>
                      <input type="date" 
                             class="form-control form-control-sm column-search" 
                             placeholder="Filter Start" 
                             data-column="3" />
                    </th>
                    <th>
                      <input type="date" 
                             class="form-control form-control-sm column-search" 
                             placeholder="Filter End" 
                             data-column="4" />
                    </th>
                    <th></th>
                    <th>
                      <select class="form-select form-select-sm column-search" data-column="6">
                        <option value="">All Status</option>
                        <option value="Upcoming">Upcoming</option>
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                      </select>
                    </th>
                    <th></th>
                  </tr>
                </thead>
                
                <tbody>
                  {% for schedule in schedules %}
                  <tr>
                    <td data-order="{{ schedule.quarter_schedule.quarter }}">
                      <span class="premium-quarter-badge 
                        {% if schedule.quarter_schedule.get_quarter_display == "1st Quarter" %}q1
                        {% elif schedule.quarter_schedule.get_quarter_display == "2nd Quarter" %}q2
                        {% elif schedule.quarter_schedule.get_quarter_display == "3rd Quarter" %}q3
                        {% elif schedule.quarter_schedule.get_quarter_display == "4th Quarter" %}q4
                        {% endif %}
                      ">
                        <i class="fas fa-calendar-alt me-1"></i>
                        {{ schedule.quarter_schedule.get_quarter_display }}
                      </span>
                    </td>
                    <td data-order="{{ schedule.quarter_schedule.year }}">
                      <span class="fw-bold text-dark">{{ schedule.quarter_schedule.year }}</span>
                    </td>
                    <td data-order="{{ schedule.section.name }}">
                      <div class="d-flex align-items-center">
                        <div style="width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                          <span class="text-white fw-bold" style="font-size: 14px;">
                            {{ schedule.section.name|slice:":1"|upper }}
                          </span>
                        </div>
                        <span class="fw-semibold text-dark">{{ schedule.section.name }}</span>
                      </div>
                    </td>
                    <td data-order="{{ schedule.start_date|date:'Y-m-d' }}">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-play-circle text-success me-2"></i>
                        <span>{{ schedule.start_date|date:"M d, Y" }}</span>
                      </div>
                    </td>
                    <td data-order="{{ schedule.end_date|date:'Y-m-d' }}">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-stop-circle text-danger me-2"></i>
                        <span>{{ schedule.end_date|date:"M d, Y" }}</span>
                      </div>
                    </td>
                    <td class="duration-cell" data-order="">
                      <span class="premium-duration-badge">
                        <i class="fas fa-clock me-1"></i>
                        <span class="duration-days" data-start="{{ schedule.start_date|date:'Y-m-d' }}" data-end="{{ schedule.end_date|date:'Y-m-d' }}"></span>
                      </span>
                    </td>
                    <td class="status-cell" data-order="">
                      <span class="schedule-status" data-start="{{ schedule.start_date|date:'Y-m-d' }}" data-end="{{ schedule.end_date|date:'Y-m-d' }}"></span>
                    </td>
                    <td>
                      {% if schedule.notes %}
                        <span class="text-muted" data-bs-toggle="tooltip" title="{{ schedule.notes }}" style="cursor: help;">
                          <i class="fas fa-comment-alt me-1"></i>
                          {{ schedule.notes|truncatewords:5 }}
                        </span>
                      {% else %}
                        <span class="text-muted">â€”</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="8" class="text-center py-5">
                      <div style="opacity: 0.5;">
                        <i class="fa fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No schedule records available</p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<style>
/* Premium Info Note (Purple Theme) */
.premium-info-note {
  background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
  color: #4c1d95;
  border: 1px solid #a78bfa;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
  transition: all 0.3s ease;
}

.premium-info-note .note-icon {
  background: #8b5cf6;
  color: white;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 18px;
  flex-shrink: 0;
}

.premium-info-note:hover {
  box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
  transform: translateY(-2px);
}

/* Premium Quarter Badges */
.premium-quarter-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-size: 0.813rem;
  font-weight: 600;
  border: 1px solid;
}

.premium-quarter-badge.q1 {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color: #1e3a8a;
  border-color: #60a5fa;
}

.premium-quarter-badge.q2 {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  color: #065f46;
  border-color: #34d399;
}

.premium-quarter-badge.q3 {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  color: #92400e;
  border-color: #fcd34d;
}

.premium-quarter-badge.q4 {
  background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
  color: #1f2937;
  border-color: #9ca3af;
}

/* Premium Duration Badge */
.premium-duration-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 1rem;
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color: #1e40af;
  border-radius: 50px;
  font-size: 0.813rem;
  font-weight: 600;
  border: 1px solid #60a5fa;
}

/* Status Badges */
.premium-status-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-size: 0.813rem;
  font-weight: 600;
  border: 1px solid;
}

.premium-status-badge.upcoming {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color: #1e40af;
  border-color: #60a5fa;
}

.premium-status-badge.active {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  color: #065f46;
  border-color: #34d399;
}

.premium-status-badge.completed {
  background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
  color: #374151;
  border-color: #9ca3af;
}

/* Add button styling */
.premium-btn-add {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.premium-btn-add:hover {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}
</style>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
$(document).ready(function() {
  console.log('Initializing Premium Schedule DataTable...');
  
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Calculate and display duration, and set data-order for sorting
  $('.duration-days').each(function() {
    const startDate = new Date($(this).data('start'));
    const endDate = new Date($(this).data('end'));
    const diffTime = Math.abs(endDate - startDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    $(this).text(diffDays + ' days');
    
    // Set data-order attribute for parent td to enable proper sorting
    $(this).closest('td').attr('data-order', diffDays);
  });

  // Calculate and display status, and set data-order for sorting
  $('.schedule-status').each(function() {
    const startDate = new Date($(this).data('start'));
    const endDate = new Date($(this).data('end'));
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let statusOrder;
    if (today < startDate) {
      $(this).html('<span class="premium-status-badge upcoming"><i class="fas fa-hourglass-start me-1"></i>Upcoming</span>');
      statusOrder = 1; // Upcoming first
    } else if (today >= startDate && today <= endDate) {
      $(this).html('<span class="premium-status-badge active"><i class="fas fa-play-circle me-1"></i>Active</span>');
      statusOrder = 2; // Active second
    } else {
      $(this).html('<span class="premium-status-badge completed"><i class="fas fa-check-circle me-1"></i>Completed</span>');
      statusOrder = 3; // Completed last
    }
    
    // Set data-order attribute for parent td to enable proper sorting
    $(this).closest('td').attr('data-order', statusOrder);
  });
  
  // Initialize DataTable
  var table = $('#schedule-table').DataTable({
    orderCellsTop: true,
    fixedHeader: false,
    pageLength: 10,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
    order: [[1, 'desc'], [0, 'asc']], // Default sort: Year descending, then Quarter ascending
    language: {
      lengthMenu: "Show _MENU_ entries",
      info: "Showing _START_ to _END_ of _TOTAL_ schedules",
      infoEmpty: "Showing 0 to 0 of 0 schedules",
      infoFiltered: "(filtered from _MAX_ total schedules)",
      zeroRecords: "No matching schedules found",
      emptyTable: "No schedule data available",
      paginate: {
        first: '<i class="fas fa-angle-double-left"></i>',
        last: '<i class="fas fa-angle-double-right"></i>',
        next: '<i class="fas fa-angle-right"></i>',
        previous: '<i class="fas fa-angle-left"></i>'
      }
    },
    columnDefs: [
      { orderable: true, targets: [0, 1, 2, 3, 4, 5, 6] },
      { orderable: false, targets: [7] } // Notes column not sortable
    ],
    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
    buttons: [
      {
        extend: 'excel',
        className: 'btn btn-sm btn-primary'
      }
    ],
    initComplete: function() {
      console.log('Premium Schedule DataTable initialized successfully');
      
      // Add animation to rows
      $('#schedule-table tbody tr').each(function(index) {
        $(this).css({
          'animation': 'fadeInUp 0.5s ease-out',
          'animation-delay': (index * 0.05) + 's',
          'animation-fill-mode': 'both'
        });
      });
    }
  });
  
  console.log('Schedule DataTable initialized');
  
  // Apply the search using data-column attribute
  $('.column-search').on('keyup change', function() {
    var columnIndex = $(this).data('column');
    var searchValue = this.value;
    
    console.log('Searching column ' + columnIndex + ' for: ' + searchValue);
    
    table.column(columnIndex).search(searchValue).draw();
  });
  
  // Add clear filters button functionality
  $('.premium-action-buttons').append(
    '<button class="premium-btn" style="background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3);" id="clearFilters">' +
    '<i class="fas fa-times"></i> Clear Filters' +
    '</button>'
  );
  
  $('#clearFilters').on('click', function() {
    $('.column-search').val('');
    table.columns().search('').draw();
    console.log('All filters cleared');
    
    $.notify({
      icon: 'fas fa-check',
      message: 'Filters have been reset'
    }, {
      type: 'info',
      placement: {
        from: 'bottom',
        align: 'right'
      },
      delay: 2000
    });
  });

  // Export button
  $('#exportBtn').on('click', function(e) {
    e.preventDefault();
    table.button('.buttons-excel').trigger();
  });

  // Remove duplicate year options
  const yearOptions = $('.column-search[data-column="1"] option');
  const uniqueYears = new Set();
  yearOptions.each(function() {
    const value = $(this).val();
    if (value && uniqueYears.has(value)) {
      $(this).remove();
    } else if (value) {
      uniqueYears.add(value);
    }
  });
  
  console.log('Schedule filter handlers attached');
});

// Add fade-in animation keyframes
if (!document.querySelector('#fadeInUpKeyframes')) {
  var style = document.createElement('style');
  style.id = 'fadeInUpKeyframes';
  style.textContent = `
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  `;
  document.head.appendChild(style);
}
</script>

{% if messages %}
<script>
  $(document).ready(function () {
    {% for message in messages %}
      $.notify({
        icon: '{% if message.tags == "success" %}fas fa-check-circle{% elif message.tags == "warning" %}fas fa-exclamation-triangle{% elif message.tags == "error" %}fas fa-times-circle{% else %}fas fa-info-circle{% endif %}',
        title: "<strong>{% if message.tags == 'success' %}Success!{% elif message.tags == 'warning' %}Warning!{% elif message.tags == 'error' %}Error!{% else %}Notice{% endif %}</strong><br>",
        message: "{{ message|escapejs }}"
      }, {
        type: "{{ message.tags }}",
        placement: {
          from: "bottom",
          align: "right"
        },
        delay: 5000,
        timer: 1000,
        animate: {
          enter: 'animated fadeInUp',
          exit: 'animated fadeOutDown'
        },
        z_index: 9999
      });
    {% endfor %}
  });
</script>
{% endif %}
{% endblock %}