{% extends 'base.html' %}
{% load static %}

{% block title %}Fill PM Checklist - {{ template.annex_code }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pm_modern.css' %}">
<style>
    .fill-checklist-page {
        background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .checklist-header-fill {
        background: var(--primary-gradient);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
    }

    .checklist-header-fill h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .checklist-header-fill h3 {
        font-size: 1.25rem;
        font-weight: 400;
        opacity: 0.95;
    }

    .checklist-item-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }

    .checklist-item-card:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transform: translateX(3px);
    }

    .item-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1.25rem;
    }

    .item-badge {
        background: var(--primary-gradient);
        color: white;
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.125rem;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .item-title {
        flex: 1;
        font-size: 1.0625rem;
        font-weight: 600;
        color: #2d3748;
        line-height: 1.5;
        margin: 0;
    }

    .status-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .status-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #4a5568;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.75rem;
        display: block;
    }

    .day-checkboxes {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .day-checkbox {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.625rem 1rem;
        text-align: center;
        min-width: 60px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .day-checkbox:hover {
        border-color: #667eea;
        background: #f7f9ff;
    }

    .day-checkbox label {
        display: block;
        font-weight: 600;
        font-size: 0.75rem;
        color: #4a5568;
        margin-bottom: 0.25rem;
        cursor: pointer;
    }

    .day-checkbox input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #667eea;
    }

    .time-check-item {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s ease;
    }

    .time-check-item:hover {
        border-color: #667eea;
        background: #f7f9ff;
    }

    .time-check-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #667eea;
    }

    .time-label {
        font-weight: 600;
        color: #2d3748;
        min-width: 80px;
    }

    .value-input {
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.375rem 0.75rem;
        width: 120px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .value-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-section {
        margin-bottom: 1rem;
    }

    .form-section-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-section-label i {
        font-size: 1rem;
    }

    .modern-textarea {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem;
        width: 100%;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        resize: vertical;
    }

    .modern-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .photo-upload-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }

    .photo-upload-box {
        position: relative;
    }

    .photo-upload-box input[type="file"] {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 2rem 1rem;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #f8f9fa;
    }

    .photo-upload-box input[type="file"]:hover {
        border-color: #667eea;
        background: #f7f9ff;
    }

    .signature-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 2rem;
        margin: 2rem 0;
    }

    .signature-section h5 {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modern-input {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        width: 100%;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
    }

    .modern-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .submit-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .btn-submit-modern {
        background: var(--primary-gradient);
        border: none;
        color: white;
        padding: 1rem 3rem;
        font-size: 1.125rem;
        font-weight: 600;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .btn-submit-modern:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }

    .progress-indicator {
        background: white;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .progress-text {
        font-weight: 600;
        color: #4a5568;
    }

    .quick-fill-btn {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        color: #4a5568;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .quick-fill-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    @media (max-width: 768px) {
        .checklist-header-fill h1 {
            font-size: 1.5rem;
        }

        .day-checkboxes {
            justify-content: center;
        }

        .photo-upload-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fill-checklist-page">
    <div class="container">
        <!-- Header -->
        <div class="checklist-header-fill">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h1>
                        <i class="fas fa-clipboard-check me-2"></i>
                        ANNEX "{{ template.annex_code }}"
                    </h1>
                    <h3>{{ template.title }}</h3>
                    <div class="mt-2" style="opacity: 0.9;">
                        <small><i class="fas fa-calendar me-2"></i>{{ template.schedule_note }}</small>
                        {% if schedule.location %}
                            <small class="ms-3"><i class="fas fa-map-marker-alt me-2"></i>{{ schedule.location }}</small>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <a href="{% url 'pm_dashboard' %}" class="btn btn-light btn-pm">
                        <i class="fas fa-arrow-left me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" id="checklistForm">
            {% csrf_token %}

            <!-- Progress Indicator -->
            <div class="progress-indicator">
                <div class="progress-text">
                    <i class="fas fa-tasks me-2"></i>
                    <span id="itemCount">{{ items.count }}</span> Items to Complete
                </div>
                <button type="button" class="quick-fill-btn" onclick="quickFillAll()">
                    <i class="fas fa-check-double me-2"></i>Quick Fill All
                </button>
            </div>

            <!-- Checklist Items -->
            {% for item in items %}
            <div class="checklist-item-card">
                <div class="item-header">
                    <div class="item-badge">{{ item.item_number }}</div>
                    <h6 class="item-title">{{ item.task_description }}</h6>
                </div>

                <!-- Status Section -->
                <div class="status-section">
                    <span class="status-label">
                        <i class="fas fa-check-circle me-1"></i> Status (Check if completed)
                    </span>

                    {% if template.annex_code == 'A' %}
                        {% if item.has_schedule_times %}
                            <!-- Items with scheduled times -->
                            <div>
                                {% for time_slot in item.schedule_times %}
                                <div class="time-check-item">
                                    <input type="checkbox"
                                           name="item_{{ item.id }}_time_{{ time_slot|lower|cut:' ' }}"
                                           id="item_{{ item.id }}_time_{{ forloop.counter }}">
                                    <label class="time-label mb-0" for="item_{{ item.id }}_time_{{ forloop.counter }}">
                                        {{ time_slot }}
                                    </label>
                                    {% if item.requires_value_input %}
                                        <input type="text"
                                               class="value-input"
                                               name="item_{{ item.id }}_value_{{ time_slot|lower|cut:' ' }}"
                                               placeholder="{{ item.value_unit }}">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <!-- Regular day checkboxes -->
                            <div class="day-checkboxes">
                                <div class="day-checkbox">
                                    <label for="item_{{ item.id }}_monday">Mon</label>
                                    <input type="checkbox" name="item_{{ item.id }}_monday" id="item_{{ item.id }}_monday">
                                </div>
                                <div class="day-checkbox">
                                    <label for="item_{{ item.id }}_tuesday">Tue</label>
                                    <input type="checkbox" name="item_{{ item.id }}_tuesday" id="item_{{ item.id }}_tuesday">
                                </div>
                                <div class="day-checkbox">
                                    <label for="item_{{ item.id }}_wednesday">Wed</label>
                                    <input type="checkbox" name="item_{{ item.id }}_wednesday" id="item_{{ item.id }}_wednesday">
                                </div>
                                <div class="day-checkbox">
                                    <label for="item_{{ item.id }}_thursday">Thu</label>
                                    <input type="checkbox" name="item_{{ item.id }}_thursday" id="item_{{ item.id }}_thursday">
                                </div>
                                <div class="day-checkbox">
                                    <label for="item_{{ item.id }}_friday">Fri</label>
                                    <input type="checkbox" name="item_{{ item.id }}_friday" id="item_{{ item.id }}_friday">
                                </div>
                            </div>
                        {% endif %}

                    {% elif template.annex_code == 'C' %}
                        <!-- Weekly with week numbers -->
                        <div class="day-checkboxes">
                            <div class="day-checkbox">
                                <label for="item_{{ item.id }}_week1">Week 1</label>
                                <input type="checkbox" name="item_{{ item.id }}_week1" id="item_{{ item.id }}_week1">
                            </div>
                            <div class="day-checkbox">
                                <label for="item_{{ item.id }}_week2">Week 2</label>
                                <input type="checkbox" name="item_{{ item.id }}_week2" id="item_{{ item.id }}_week2">
                            </div>
                            <div class="day-checkbox">
                                <label for="item_{{ item.id }}_week3">Week 3</label>
                                <input type="checkbox" name="item_{{ item.id }}_week3" id="item_{{ item.id }}_week3">
                            </div>
                            <div class="day-checkbox">
                                <label for="item_{{ item.id }}_week4">Week 4</label>
                                <input type="checkbox" name="item_{{ item.id }}_week4" id="item_{{ item.id }}_week4">
                            </div>
                        </div>

                    {% else %}
                        <!-- Simple completion checkbox -->
                        <div class="time-check-item">
                            <input type="checkbox"
                                   name="item_{{ item.id }}_completed"
                                   id="item_{{ item.id }}_completed">
                            <label class="time-label mb-0" for="item_{{ item.id }}_completed">
                                Task Completed
                            </label>
                        </div>
                    {% endif %}
                </div>

                <!-- Problems & Actions -->
                <div class="row">
                    <div class="col-md-6 form-section">
                        <label class="form-section-label">
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                            Problems Encountered
                        </label>
                        <textarea class="modern-textarea"
                                  name="item_{{ item.id }}_problems"
                                  rows="2"
                                  placeholder="Describe any issues..."></textarea>
                    </div>
                    <div class="col-md-6 form-section">
                        <label class="form-section-label">
                            <i class="fas fa-wrench text-info"></i>
                            Action Taken
                        </label>
                        <textarea class="modern-textarea"
                                  name="item_{{ item.id }}_action"
                                  rows="2"
                                  placeholder="Describe actions..."></textarea>
                    </div>
                </div>

                <!-- Photo Uploads -->
                <div class="form-section">
                    <label class="form-section-label">
                        <i class="fas fa-camera text-success"></i>
                        Photo Evidence (Optional)
                    </label>
                    <div class="photo-upload-grid">
                        <div class="photo-upload-box">
                            <input type="file" name="item_{{ item.id }}_photo1" accept="image/*">
                        </div>
                        <div class="photo-upload-box">
                            <input type="file" name="item_{{ item.id }}_photo2" accept="image/*">
                        </div>
                        <div class="photo-upload-box">
                            <input type="file" name="item_{{ item.id }}_photo3" accept="image/*">
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- General Notes -->
            <div class="checklist-item-card">
                <h6 class="form-section-label" style="font-size: 1rem; margin-bottom: 1rem;">
                    <i class="fas fa-sticky-note"></i>
                    General Notes
                </h6>
                <textarea class="modern-textarea"
                          name="general_notes"
                          rows="4"
                          placeholder="Add any additional observations or comments..."></textarea>
            </div>

            <!-- Signature Section -->
            <div class="signature-section">
                <h5>
                    <i class="fas fa-signature"></i>
                    Signature & Verification
                </h5>
                <p class="text-muted mb-3">Complete your checklist by providing your signature</p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-section-label">Upload Signature Image</label>
                        <input type="file"
                               class="modern-input"
                               name="signature_image"
                               accept="image/*">
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i> Use camera or upload existing signature
                        </small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-section-label">Printed Name *</label>
                        <input type="text"
                               class="modern-input"
                               name="printed_name"
                               placeholder="Enter your full name"
                               required
                               value="{{ request.user.get_full_name|default:request.user.username }}">
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="submit-section">
                <h6 class="mb-3" style="color: #4a5568;">Ready to submit your checklist?</h6>
                <button type="submit" class="btn-submit-modern">
                    <i class="fas fa-paper-plane me-2"></i>
                    Submit Checklist
                </button>
                <p class="text-muted mt-3 mb-0">
                    <small>Please review all entries before submitting</small>
                </p>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('checklistForm').addEventListener('submit', function(e) {
    if (!confirm('Are you sure you want to submit this checklist? Please ensure all information is correct.')) {
        e.preventDefault();
    }
});

function quickFillAll() {
    if (confirm('This will check all completion boxes. Continue?')) {
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });
    }
}

// Update item count based on checked items
document.addEventListener('change', function(e) {
    if (e.target.type === 'checkbox') {
        const totalItems = {{ items.count }};
        const cards = document.querySelectorAll('.checklist-item-card');
        let completed = 0;

        cards.forEach(card => {
            const checkboxes = card.querySelectorAll('input[type="checkbox"]');
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            if (anyChecked) completed++;
        });

        document.getElementById('itemCount').textContent = totalItems - completed;
    }
});
</script>
{% endblock %}
