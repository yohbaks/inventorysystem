{% extends 'base.html' %}
{% load static %}

{% block title %}Generate PM Report{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pm_modern.css' %}">
{% endblock %}

{% block content %}
<div class="pm-page">
    <div class="container">
        <div class="page-inner">
            <!-- Header -->
            <div class="pm-header">
                <div class="d-flex align-items-center justify-content-between flex-wrap">
                    <div>
                        <h3>Generate PM Report</h3>
                        <h6>Create a New Preventive Maintenance Report</h6>
                    </div>
                    <div class="mt-3 mt-md-0">
                        <a href="{% url 'pm_reports' %}" class="btn btn-outline-light btn-pm">
                            <i class="fas fa-arrow-left me-2"></i>Back to Reports
                        </a>
                    </div>
                </div>
            </div>

            <!-- Form -->
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <div class="pm-card">
                        <div class="pm-card-header">
                            <h5><i class="fas fa-file-alt me-2"></i>Report Parameters</h5>
                        </div>
                        <div class="pm-card-body">
                            <form method="POST">
                                {% csrf_token %}

                                <div class="pm-form-group">
                                    <label class="pm-form-label">Report Type *</label>
                                    <select name="report_type" class="pm-form-control" required id="reportType">
                                        <option value="">Select Report Type</option>
                                        <option value="WEEKLY">Weekly Report</option>
                                        <option value="MONTHLY">Monthly Report</option>
                                        <option value="QUARTERLY">Quarterly Report</option>
                                        <option value="ANNUAL">Annual Report</option>
                                        <option value="CUSTOM">Custom Period</option>
                                    </select>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 pm-form-group">
                                        <label class="pm-form-label">Period Start *</label>
                                        <input type="date" name="period_start" class="pm-form-control" required id="periodStart">
                                    </div>
                                    <div class="col-md-6 pm-form-group">
                                        <label class="pm-form-label">Period End *</label>
                                        <input type="date" name="period_end" class="pm-form-control" required id="periodEnd">
                                    </div>
                                </div>

                                <div class="pm-form-group">
                                    <label class="pm-form-label">Annex Filter (Optional)</label>
                                    <select name="annex_filter" class="pm-form-control">
                                        <option value="">All Annexes</option>
                                        {% for template in templates %}
                                            <option value="{{ template.annex_code }}">Annex {{ template.annex_code }} - {{ template.title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="pm-alert pm-alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    The report will include statistics and details for all checklists within the selected period. A PDF will be generated automatically.
                                </div>

                                <div class="d-flex justify-content-between pt-3">
                                    <a href="{% url 'pm_reports' %}" class="btn btn-pm-secondary">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-pm-primary">
                                        <i class="fas fa-file-pdf me-2"></i>Generate Report
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportType = document.getElementById('reportType');
    const periodStart = document.getElementById('periodStart');
    const periodEnd = document.getElementById('periodEnd');

    reportType.addEventListener('change', function() {
        const today = new Date();
        let start, end;

        switch(this.value) {
            case 'WEEKLY':
                start = new Date(today);
                start.setDate(today.getDate() - today.getDay());
                end = new Date(start);
                end.setDate(start.getDate() + 6);
                break;
            case 'MONTHLY':
                start = new Date(today.getFullYear(), today.getMonth(), 1);
                end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                break;
            case 'QUARTERLY':
                const quarter = Math.floor(today.getMonth() / 3);
                start = new Date(today.getFullYear(), quarter * 3, 1);
                end = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
                break;
            case 'ANNUAL':
                start = new Date(today.getFullYear(), 0, 1);
                end = new Date(today.getFullYear(), 11, 31);
                break;
            default:
                return;
        }

        periodStart.value = start.toISOString().split('T')[0];
        periodEnd.value = end.toISOString().split('T')[0];
    });
});
</script>
{% endblock %}
