{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Complete PM Checklist - {{ today_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-clipboard-check"></i> Preventive Maintenance Checklist - {{ today_name }}, {{ today|date:"F d, Y" }}
                    </h3>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <form method="post" id="pm-checklist-form">
                        {% csrf_token %}

                        {% if is_late_submission %}
                        <div class="alert alert-danger">
                            <h6 class="alert-heading">
                                <i class="fas fa-exclamation-triangle"></i> LATE SUBMISSION WARNING
                            </h6>
                            <p class="mb-2"><strong>You are filling out a checklist for a past date!</strong></p>
                            <ul class="mb-2">
                                <li><strong>Scheduled Date:</strong> {{ today|date:"l, F d, Y" }}</li>
                                <li><strong>Actual Date:</strong> {{ today_actual|date:"l, F d, Y" }}</li>
                                <li><strong>Days Late:</strong> {{ days_late }} day{{ days_late|pluralize }}</li>
                            </ul>
                            <p class="mb-0">
                                <i class="fas fa-clipboard-check"></i> <strong>Reminder:</strong> PM checklists should be completed on schedule. This entry will be marked as a late submission in all reports.
                            </p>
                        </div>
                        {% endif %}

                        {% if existing_completion %}
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-edit"></i> Update Mode - Editing Existing Checklist
                            </h6>
                            <p class="mb-2">This checklist was already completed. All existing data has been pre-filled in the form fields below.</p>
                            <ul class="mb-0">
                                <li>✓ All checkboxes reflect current completion status</li>
                                <li>✓ Problems and actions are pre-filled for your review</li>
                                <li>✓ Readings are loaded from previous submission</li>
                                <li><strong>Make your changes and click Submit to update</strong></li>
                            </ul>
                        </div>
                        {% endif %}

                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle"></i> Instructions
                            </h6>
                            <ul class="mb-0">
                                <li>Check the box for each task you have completed</li>
                                <li>Note any problems encountered and actions taken</li>
                                <li><strong class="text-danger">NEW:</strong> For Items 1-2, click "Log Downtime Event" to record equipment downtime</li>
                                <li>Items 1-2 are DAILY tasks (should be done every day)</li>
                                <li>Items 3-5 have MULTIPLE READINGS throughout the day</li>
                                <li><strong>Items 6-11 are WEEKLY tasks (done only on Friday)</strong></li>
                                {% if not is_friday %}
                                    <li class="text-warning"><strong>Note:</strong> Items 6-11 are disabled today. They will be available on Friday.</li>
                                {% endif %}
                            </ul>
                        </div>

                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width: 5%">No.</th>
                                    <th style="width: 40%">Task Description</th>
                                    <th style="width: 10%">Done</th>
                                    <th style="width: 45%">Problems Encountered / Action Taken</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr {% if item.item_number >= 6 and item.item_number <= 11 %}class="table-secondary"{% endif %}
                                    {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}style="opacity: 0.6;"{% endif %}{% endif %}>
                                    <td class="text-center">
                                        <strong>{{ item.item_number }}</strong>
                                        {% if item.item_number >= 6 and item.item_number <= 11 %}
                                            <br><small class="badge badge-dark">WEEKLY (Friday Only)</small>
                                        {% else %}
                                            <br><small class="badge badge-info">DAILY</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ item.task_description|linebreaks }}
                                        {% if item.has_schedule_times %}
                                            <div class="mt-2">
                                                <strong>Scheduled Times:</strong>
                                                <span class="badge badge-light">{{ item.schedule_times|join:", " }}</span>
                                            </div>
                                        {% endif %}
                                        {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}
                                            <div class="mt-2">
                                                <small class="text-muted"><i class="fas fa-info-circle"></i> This task will be available on Friday</small>
                                            </div>
                                        {% endif %}{% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if not is_friday and item.item_number >= 6 and item.item_number <= 11 %}
                                            <!-- Weekly items locked on Mon-Thu -->
                                            <i class="fas fa-lock text-muted"></i>
                                        {% else %}
                                            <!-- All items on Friday, items 1-5 on Mon-Thu -->
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox"
                                                       class="custom-control-input"
                                                       id="item_{{ item.id }}"
                                                       name="item_{{ item.id }}"
                                                       {% if item.is_checked %}checked{% endif %}>
                                                <label class="custom-control-label" for="item_{{ item.id }}">
                                                    <i class="fas fa-check text-success"></i>
                                                </label>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.has_schedule_times and item.item_number == 3 or item.item_number == 4 or item.item_number == 5 %}
                                            <!-- Multiple readings for scheduled items -->
                                            <div class="scheduled-readings">
                                                <label class="small font-weight-bold">Record Readings:</label>
                                                {% for time in item.schedule_times %}
                                                <div class="input-group input-group-sm mb-2">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text" style="width: 80px;">{{ time }}</span>
                                                    </div>
                                                    <input type="text"
                                                           class="form-control"
                                                           name="reading_{{ item.id }}_{{ forloop.counter0 }}"
                                                           value="{% if forloop.counter0 < item.existing_readings|length %}{{ item.existing_readings|index:forloop.counter0 }}{% endif %}"
                                                           placeholder="{% if item.item_number == 3 %}e.g., OK or 75%{% elif item.item_number == 4 %}e.g., 24°C{% elif item.item_number == 5 %}e.g., 45%{% endif %}"
                                                           {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}disabled{% endif %}{% endif %}>
                                                </div>
                                                {% endfor %}
                                                <small class="text-muted">
                                                    {% if item.item_number == 3 %}Enter utilization % or status (OK/High)
                                                    {% elif item.item_number == 4 %}Enter temperature (e.g., 24°C or 75°F)
                                                    {% elif item.item_number == 5 %}Enter humidity % (e.g., 45%)
                                                    {% endif %}
                                                </small>
                                            </div>

                                            <!-- Problems field -->
                                            <div class="form-group mb-0 mt-3">
                                                <label for="problems_{{ item.id }}" class="small">Problems/Notes:</label>
                                                <textarea class="form-control form-control-sm"
                                                          id="problems_{{ item.id }}"
                                                          name="problems_{{ item.id }}"
                                                          rows="2"
                                                          placeholder="Any issues or additional notes..."
                                                          {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}disabled{% endif %}{% endif %}>{{ item.existing_problems }}</textarea>
                                            </div>
                                        {% else %}
                                            <!-- Standard problems/actions for non-scheduled items -->
                                            <div class="form-group mb-2">
                                                <label for="problems_{{ item.id }}" class="small">Problems:</label>
                                                <textarea class="form-control form-control-sm"
                                                          id="problems_{{ item.id }}"
                                                          name="problems_{{ item.id }}"
                                                          rows="2"
                                                          placeholder="Describe any problems..."
                                                          {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}disabled{% endif %}{% endif %}>{{ item.existing_problems }}</textarea>
                                            </div>
                                            <div class="form-group mb-0">
                                                <label for="action_{{ item.id }}" class="small">Action Taken:</label>
                                                <textarea class="form-control form-control-sm"
                                                          id="action_{{ item.id }}"
                                                          name="action_{{ item.id }}"
                                                          rows="2"
                                                          placeholder="Describe action taken..."
                                                          {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}disabled{% endif %}{% endif %}>{{ item.existing_action }}</textarea>
                                            </div>

                                            <!-- Downtime Logging Section (for critical equipment items 1 and 2) -->
                                            {% if item.item_number == 1 or item.item_number == 2 %}
                                            <div class="mt-3">
                                                <!-- Hidden fields for downtime data (populated by modal) -->
                                                <input type="hidden" id="downtime_date_{{ item.id }}" name="downtime_date_{{ item.id }}">
                                                <input type="hidden" id="downtime_start_{{ item.id }}" name="downtime_start_{{ item.id }}">
                                                <input type="hidden" id="downtime_end_{{ item.id }}" name="downtime_end_{{ item.id }}">
                                                <input type="hidden" id="downtime_equipment_{{ item.id }}" name="downtime_equipment_{{ item.id }}">
                                                <input type="hidden" id="downtime_severity_{{ item.id }}" name="downtime_severity_{{ item.id }}">
                                                <input type="hidden" id="downtime_cause_{{ item.id }}" name="downtime_cause_{{ item.id }}">
                                                <input type="hidden" id="downtime_resolution_{{ item.id }}" name="downtime_resolution_{{ item.id }}">
                                                <input type="hidden" id="downtime_services_{{ item.id }}" name="downtime_services_{{ item.id }}">
                                                <input type="hidden" id="downtime_users_{{ item.id }}" name="downtime_users_{{ item.id }}">

                                                <!-- Modal button for downtime logging -->
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger downtime-log-btn"
                                                        data-item-id="{{ item.id }}"
                                                        data-item-completion-id="{{ item.completion_id|default:'' }}"
                                                        data-item-number="{{ item.item_number }}"
                                                        data-item-description="{{ item.task_description|striptags|truncatewords:5 }}">
                                                    <i class="fas fa-exclamation-circle"></i> Log Downtime Event
                                                </button>

                                                <!-- Display indicator if downtime has been logged -->
                                                <span id="downtime_indicator_{{ item.id }}" class="ml-2 text-success" style="display: none;">
                                                    <i class="fas fa-check-circle"></i> Downtime logged
                                                </span>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="card bg-light mt-4">
                            <div class="card-body">
                                <h6 class="font-weight-bold mb-3">
                                    <i class="fas fa-signature"></i> Accomplished by:
                                </h6>
                                <div class="form-group">
                                    <label for="printed_name">Printed Name:</label>
                                    <input type="text"
                                           class="form-control"
                                           id="printed_name"
                                           name="printed_name"
                                           required
                                           value="{{ request.user.get_full_name|default:request.user.username }}"
                                           placeholder="Enter your full name">
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <h6 class="alert-heading">
                                <i class="fas fa-calendar-check"></i> Auto-Dated Entry
                            </h6>
                            This completion will automatically be recorded for <strong>{{ today_name }}</strong>.
                            You cannot select a different day. The system automatically knows which day it is.
                        </div>

                        <div class="mt-4 text-center">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Submit Checklist for {{ today_name }}
                            </button>
                            <a href="{% url 'pm_daily_dashboard' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Downtime Logging Modal -->
<div class="modal fade" id="downtimeModal" tabindex="-1" role="dialog" aria-labelledby="downtimeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="downtimeModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Log Equipment Downtime Event
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="downtimeForm">
                    {% csrf_token %}
                    <input type="hidden" id="downtime_item_completion_id" name="item_completion_id">

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Quick Log:</strong> Record equipment downtime to track service interruptions and analyze trends.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="occurrence_date"><strong>Date of Downtime:</strong></label>
                                <input type="date"
                                       class="form-control"
                                       id="occurrence_date"
                                       name="occurrence_date"
                                       value="{{ today|date:'Y-m-d' }}"
                                       required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="start_time"><strong>Start Time:</strong></label>
                                <input type="time"
                                       class="form-control"
                                       id="start_time"
                                       name="start_time"
                                       required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="end_time">End Time:</label>
                                <input type="time"
                                       class="form-control"
                                       id="end_time"
                                       name="end_time">
                                <small class="text-muted">Leave blank if ongoing</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="equipment_name"><strong>Equipment/System Name:</strong></label>
                        <input type="text"
                               class="form-control"
                               id="equipment_name"
                               name="equipment_name"
                               placeholder="e.g., Server-01, Main AC Unit, UPS-A"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="severity"><strong>Severity Level:</strong></label>
                        <select class="form-control" id="severity" name="severity" required>
                            <option value="MINOR">Minor - No service impact</option>
                            <option value="MODERATE" selected>Moderate - Partial impact</option>
                            <option value="MAJOR">Major - Significant impact</option>
                            <option value="CRITICAL">Critical - Complete service loss</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="cause_description"><strong>Cause/Description:</strong></label>
                        <textarea class="form-control"
                                  id="cause_description"
                                  name="cause_description"
                                  rows="3"
                                  placeholder="Describe what caused the downtime..."
                                  required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="resolution_notes">Resolution/Action Taken:</label>
                        <textarea class="form-control"
                                  id="resolution_notes"
                                  name="resolution_notes"
                                  rows="2"
                                  placeholder="What was done to resolve the issue..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="services_affected">Services Affected:</label>
                                <input type="text"
                                       class="form-control"
                                       id="services_affected"
                                       name="services_affected"
                                       placeholder="e.g., Email, File Server, Cooling">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="users_affected_count">Users Affected:</label>
                                <input type="number"
                                       class="form-control"
                                       id="users_affected_count"
                                       name="users_affected_count"
                                       placeholder="Number"
                                       min="0">
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-magic"></i> <strong>Auto-fill:</strong> This information will be automatically added to the "Problems" and "Action Taken" fields in your checklist.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="submitDowntimeBtn">
                    <i class="fas fa-save"></i> Log Downtime Event
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('pm-checklist-form').addEventListener('submit', function(e) {
    var printedName = document.getElementById('printed_name').value.trim();
    if (!printedName) {
        e.preventDefault();
        alert('Please enter your printed name before submitting.');
        return false;
    }

    var confirmed = confirm('Are you sure you want to submit this PM checklist for {{ today_name }}?');
    if (!confirmed) {
        e.preventDefault();
        return false;
    }
});

// Downtime Logging Modal Functionality
document.addEventListener('DOMContentLoaded', function() {
    let currentItemId = null;
    let currentItemCompletionId = null;
    let currentDowntimeEventId = null;  // Track if we're editing an existing event

    // Handle "Log Downtime" button clicks
    const downtimeButtons = document.querySelectorAll('.downtime-log-btn');

    downtimeButtons.forEach(button => {
        button.addEventListener('click', function() {
            currentItemId = this.dataset.itemId;
            currentItemCompletionId = this.dataset.itemCompletionId;
            const itemNumber = this.dataset.itemNumber;
            const itemDescription = this.dataset.itemDescription;

            // Set the item completion ID in the hidden field (for AJAX mode)
            document.getElementById('downtime_item_completion_id').value = currentItemCompletionId || '';

            // Update modal title with item context
            document.getElementById('downtimeModalLabel').innerHTML =
                '<i class="fas fa-exclamation-triangle"></i> Log Downtime - Item #' + itemNumber + ': ' + itemDescription;

            // Reset form first
            document.getElementById('downtimeForm').reset();
            document.getElementById('occurrence_date').value = '{{ today|date:"Y-m-d" }}';
            currentDowntimeEventId = null;  // Reset event ID

            // If we have an item completion ID, fetch existing downtime events
            if (currentItemCompletionId) {
                fetchExistingDowntimeData(currentItemCompletionId);
            } else if (currentItemId) {
                // Otherwise, check for data in hidden fields (pre-submission state)
                loadFromHiddenFields(currentItemId);
            }

            // Show modal
            $('#downtimeModal').modal('show');
        });
    });

    function fetchExistingDowntimeData(itemCompletionId) {
        // Show loading indicator
        const submitBtn = document.getElementById('submitDowntimeBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

        // Fetch existing downtime events from the server
        fetch(`/pm/downtime/get/${itemCompletionId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.events.length > 0) {
                    // Load the most recent event into the form
                    const event = data.events[0];
                    currentDowntimeEventId = event.id;

                    // Populate form fields
                    document.getElementById('occurrence_date').value = event.occurrence_date;
                    document.getElementById('start_time').value = event.start_time;
                    document.getElementById('end_time').value = event.end_time;
                    document.getElementById('equipment_name').value = event.equipment_name;
                    document.getElementById('severity').value = event.severity;
                    document.getElementById('cause_description').value = event.cause_description;
                    document.getElementById('resolution_notes').value = event.resolution_notes;
                    document.getElementById('services_affected').value = event.services_affected;
                    document.getElementById('users_affected_count').value = event.users_affected_count;

                    // Update modal title to indicate editing
                    document.getElementById('downtimeModalLabel').innerHTML =
                        '<i class="fas fa-edit"></i> Edit Downtime Event (ID: ' + event.id + ')';

                    // Update button text
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Downtime Event';
                } else {
                    // No existing events, show create mode
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Log Downtime Event';
                }
            })
            .catch(error => {
                console.error('Error fetching downtime data:', error);
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Log Downtime Event';
            })
            .finally(() => {
                submitBtn.disabled = false;
            });
    }

    function loadFromHiddenFields(itemId) {
        // Load data from hidden fields (pre-submission state)
        const dateField = document.getElementById('downtime_date_' + itemId);
        const startField = document.getElementById('downtime_start_' + itemId);
        const endField = document.getElementById('downtime_end_' + itemId);
        const equipmentField = document.getElementById('downtime_equipment_' + itemId);
        const severityField = document.getElementById('downtime_severity_' + itemId);
        const causeField = document.getElementById('downtime_cause_' + itemId);
        const resolutionField = document.getElementById('downtime_resolution_' + itemId);
        const servicesField = document.getElementById('downtime_services_' + itemId);
        const usersField = document.getElementById('downtime_users_' + itemId);

        if (dateField && dateField.value) document.getElementById('occurrence_date').value = dateField.value;
        if (startField && startField.value) document.getElementById('start_time').value = startField.value;
        if (endField && endField.value) document.getElementById('end_time').value = endField.value;
        if (equipmentField && equipmentField.value) document.getElementById('equipment_name').value = equipmentField.value;
        if (severityField && severityField.value) document.getElementById('severity').value = severityField.value;
        if (causeField && causeField.value) document.getElementById('cause_description').value = causeField.value;
        if (resolutionField && resolutionField.value) document.getElementById('resolution_notes').value = resolutionField.value;
        if (servicesField && servicesField.value) document.getElementById('services_affected').value = servicesField.value;
        if (usersField && usersField.value) document.getElementById('users_affected_count').value = usersField.value;
    }

    // Handle modal close buttons manually
    const closeModalButtons = document.querySelectorAll('[data-dismiss="modal"]');
    closeModalButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            $('#downtimeModal').modal('hide');
        });
    });

    // Handle downtime form submission
    document.getElementById('submitDowntimeBtn').addEventListener('click', function() {
        const form = document.getElementById('downtimeForm');

        // Validate required fields
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Determine submission mode: update, create via AJAX, or populate hidden fields
        if (currentDowntimeEventId) {
            // We're editing an existing event - update it
            updateViaAjax(form, currentDowntimeEventId);
        } else if (currentItemCompletionId) {
            // We're creating a new event for an existing completion - submit via AJAX
            submitViaAjax(form, currentItemCompletionId);
        } else {
            // Pre-submission state - populate hidden fields
            populateHiddenFields(form, currentItemId);
        }
    });

    function populateHiddenFields(form, itemId) {
        // Get form data
        const occurrenceDate = document.getElementById('occurrence_date').value;
        const startTime = document.getElementById('start_time').value;
        const endTime = document.getElementById('end_time').value;
        const equipmentName = document.getElementById('equipment_name').value;
        const severity = document.getElementById('severity').value;
        const causeDescription = document.getElementById('cause_description').value;
        const resolutionNotes = document.getElementById('resolution_notes').value;
        const servicesAffected = document.getElementById('services_affected').value;
        const usersAffected = document.getElementById('users_affected_count').value;

        // Populate hidden fields with form data
        document.getElementById('downtime_date_' + itemId).value = occurrenceDate;
        document.getElementById('downtime_start_' + itemId).value = startTime;
        document.getElementById('downtime_end_' + itemId).value = endTime;
        document.getElementById('downtime_equipment_' + itemId).value = equipmentName;
        document.getElementById('downtime_severity_' + itemId).value = severity;
        document.getElementById('downtime_cause_' + itemId).value = causeDescription;
        document.getElementById('downtime_resolution_' + itemId).value = resolutionNotes;
        document.getElementById('downtime_services_' + itemId).value = servicesAffected;
        document.getElementById('downtime_users_' + itemId).value = usersAffected;

        // Auto-populate the Problems field with downtime summary
        let downtimeSummary = `DOWNTIME: ${occurrenceDate} ${startTime}`;
        if (endTime) {
            downtimeSummary += ` - ${endTime}`;
        }
        downtimeSummary += ` | ${equipmentName} | ${severity} | ${causeDescription}`;

        // Get the problems textarea and update it
        const problemsTextarea = document.getElementById('problems_' + itemId);
        if (problemsTextarea) {
            // Append to existing problems or create new
            if (problemsTextarea.value.trim()) {
                problemsTextarea.value += '\n\n' + downtimeSummary;
            } else {
                problemsTextarea.value = downtimeSummary;
            }
        }

        // Auto-populate the Action Taken field with resolution notes
        const actionTextarea = document.getElementById('action_' + itemId);
        if (actionTextarea && resolutionNotes) {
            // Append to existing action or create new
            if (actionTextarea.value.trim()) {
                actionTextarea.value += '\n\n' + resolutionNotes;
            } else {
                actionTextarea.value = resolutionNotes;
            }
        }

        // Show indicator
        const indicator = document.getElementById('downtime_indicator_' + itemId);
        if (indicator) {
            indicator.style.display = 'inline';
        }

        // Close modal
        $('#downtimeModal').modal('hide');

        // Show success message
        alert('✓ Downtime information saved!\n\nThe downtime summary has been added to the Problems field' + (resolutionNotes ? ' and Resolution/Action has been added to the Action Taken field' : '') + '. The downtime event will be logged when you submit the checklist.');
    }

    function submitViaAjax(form, itemCompletionId) {
        const formData = new FormData(form);
        const submitBtn = document.getElementById('submitDowntimeBtn');

        // Disable submit button to prevent double-submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging...';

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Submit via AJAX
        fetch(`/pm/downtime/log/${itemCompletionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                $('#downtimeModal').modal('hide');

                // Show success message
                alert('✓ Downtime event logged successfully!\n\nDuration: ' + data.duration + '\n\nThe downtime information has been added to the Problems field.');

                // Reload to show updated data
                window.location.reload();
            } else {
                alert('Error logging downtime: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to log downtime event. Please try again.');
        })
        .finally(() => {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Log Downtime Event';
        });
    }

    function updateViaAjax(form, eventId) {
        const formData = new FormData(form);
        const submitBtn = document.getElementById('submitDowntimeBtn');

        // Disable submit button to prevent double-submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Update via AJAX
        fetch(`/pm/downtime/update/${eventId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                $('#downtimeModal').modal('hide');

                // Show success message
                alert('✓ Downtime event updated successfully!\n\nDuration: ' + data.duration);

                // Reload to show updated data
                window.location.reload();
            } else {
                alert('Error updating downtime: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update downtime event. Please try again.');
        })
        .finally(() => {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Downtime Event';
        });
    }
});
</script>

<style>
    .table-secondary {
        background-color: #e9ecef !important;
    }

    .custom-control-input:checked ~ .custom-control-label i {
        font-size: 1.5em;
    }
</style>
{% endblock %}
