{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Complete PM Checklist - {{ today_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3>PREVENTIVE MAINTENANCE CHECKLIST</h3>
                    <h5>{{ today_name }}, {{ today|date:"F d, Y" }}</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="pm-checklist-form">
                        {% csrf_token %}

                        {% if is_late_submission %}
                        <div class="alert alert-danger border-danger" style="border-left: 5px solid #dc3545 !important;">
                            <h5 class="alert-heading">
                                <i class="fas fa-exclamation-triangle"></i> LATE SUBMISSION WARNING
                            </h5>
                            <p class="mb-2"><strong>You are filling out a checklist for a past date!</strong></p>
                            <ul class="mb-2">
                                <li><strong>Scheduled Date:</strong> {{ today|date:"l, F d, Y" }}</li>
                                <li><strong>Actual Date:</strong> {{ today_actual|date:"l, F d, Y" }}</li>
                                <li><strong>Days Late:</strong> {{ days_late }} day{{ days_late|pluralize }}</li>
                            </ul>
                            <p class="mb-0 text-danger">
                                <i class="fas fa-clipboard-check"></i> <strong>Reminder:</strong> PM checklists should be completed on schedule. This entry will be marked as a late submission in all reports.
                            </p>
                        </div>
                        {% endif %}

                        {% if existing_completion %}
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i> <strong>Update Mode:</strong> This checklist was already completed. You can update readings/notes throughout the day.
                        </div>
                        {% endif %}

                        <div class="alert alert-info">
                            <strong>Instructions:</strong>
                            <ul>
                                <li>Check the box for each task you have completed</li>
                                <li>Note any problems encountered and actions taken</li>
                                <li>Items 1-2 are DAILY tasks (should be done every day)</li>
                                <li>Items 3-5 have MULTIPLE READINGS throughout the day</li>
                                <li><strong>Items 6-11 are WEEKLY tasks (done only on Friday)</strong></li>
                                {% if not is_friday %}
                                    <li class="text-warning"><strong>Note:</strong> Items 6-11 are disabled today. They will be available on Friday.</li>
                                {% endif %}
                            </ul>
                        </div>

                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width: 5%">No.</th>
                                    <th style="width: 40%">Task Description</th>
                                    <th style="width: 10%">Done</th>
                                    <th style="width: 45%">Problems Encountered / Action Taken</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr {% if item.item_number >= 6 and item.item_number <= 11 %}class="table-secondary"{% endif %}
                                    {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}style="opacity: 0.6;"{% endif %}{% endif %}>
                                    <td class="text-center">
                                        <strong>{{ item.item_number }}</strong>
                                        {% if item.item_number >= 6 and item.item_number <= 11 %}
                                            <br><small class="badge badge-dark">WEEKLY (Friday Only)</small>
                                        {% else %}
                                            <br><small class="badge badge-info">DAILY</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ item.task_description|linebreaks }}
                                        {% if item.has_schedule_times %}
                                            <div class="mt-2">
                                                <strong>Scheduled Times:</strong>
                                                <span class="badge badge-light">{{ item.schedule_times|join:", " }}</span>
                                            </div>
                                        {% endif %}
                                        {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}
                                            <div class="mt-2">
                                                <small class="text-muted"><i class="fas fa-info-circle"></i> This task will be available on Friday</small>
                                            </div>
                                        {% endif %}{% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}
                                            <i class="fas fa-lock text-muted"></i>
                                        {% else %}
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox"
                                                       class="custom-control-input"
                                                       id="item_{{ item.id }}"
                                                       name="item_{{ item.id }}"
                                                       {% if item.is_checked %}checked{% endif %}>
                                                <label class="custom-control-label" for="item_{{ item.id }}">
                                                    <i class="fas fa-check text-success"></i>
                                                </label>
                                            </div>
                                        {% endif %}{% endif %}
                                    </td>
                                    <td>
                                        {% if item.has_schedule_times and item.item_number == 3 or item.item_number == 4 or item.item_number == 5 %}
                                            <!-- Multiple readings for scheduled items -->
                                            <div class="scheduled-readings">
                                                <label class="small font-weight-bold">Record Readings:</label>
                                                {% for time in item.schedule_times %}
                                                <div class="input-group input-group-sm mb-2">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text" style="width: 80px;">{{ time }}</span>
                                                    </div>
                                                    <input type="text"
                                                           class="form-control"
                                                           name="reading_{{ item.id }}_{{ forloop.counter0 }}"
                                                           value="{% if forloop.counter0 < item.existing_readings|length %}{{ item.existing_readings|index:forloop.counter0 }}{% endif %}"
                                                           placeholder="{% if item.item_number == 3 %}e.g., OK or 75%{% elif item.item_number == 4 %}e.g., 24°C{% elif item.item_number == 5 %}e.g., 45%{% endif %}"
                                                           {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}disabled{% endif %}{% endif %}>
                                                </div>
                                                {% endfor %}
                                                <small class="text-muted">
                                                    {% if item.item_number == 3 %}Enter utilization % or status (OK/High)
                                                    {% elif item.item_number == 4 %}Enter temperature (e.g., 24°C or 75°F)
                                                    {% elif item.item_number == 5 %}Enter humidity % (e.g., 45%)
                                                    {% endif %}
                                                </small>
                                            </div>

                                            <!-- Problems field -->
                                            <div class="form-group mb-0 mt-3">
                                                <label for="problems_{{ item.id }}" class="small">Problems/Notes:</label>
                                                <textarea class="form-control form-control-sm"
                                                          id="problems_{{ item.id }}"
                                                          name="problems_{{ item.id }}"
                                                          rows="2"
                                                          placeholder="Any issues or additional notes..."
                                                          {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}disabled{% endif %}{% endif %}></textarea>
                                            </div>
                                        {% else %}
                                            <!-- Standard problems/actions for non-scheduled items -->
                                            <div class="form-group mb-2">
                                                <label for="problems_{{ item.id }}" class="small">Problems:</label>
                                                <textarea class="form-control form-control-sm"
                                                          id="problems_{{ item.id }}"
                                                          name="problems_{{ item.id }}"
                                                          rows="2"
                                                          placeholder="Describe any problems..."
                                                          {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}disabled{% endif %}{% endif %}></textarea>
                                            </div>
                                            <div class="form-group mb-0">
                                                <label for="action_{{ item.id }}" class="small">Action Taken:</label>
                                                <textarea class="form-control form-control-sm"
                                                          id="action_{{ item.id }}"
                                                          name="action_{{ item.id }}"
                                                          rows="2"
                                                          placeholder="Describe action taken..."
                                                          {% if not is_friday %}{% if item.item_number >= 6 and item.item_number <= 11 %}disabled{% endif %}{% endif %}></textarea>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="form-group mt-4">
                            <label for="printed_name"><strong>Printed Name:</strong></label>
                            <input type="text"
                                   class="form-control"
                                   id="printed_name"
                                   name="printed_name"
                                   required
                                   value="{{ request.user.get_full_name|default:request.user.username }}"
                                   placeholder="Enter your full name">
                        </div>

                        <div class="alert alert-warning">
                            <strong>Note:</strong> This completion will automatically be recorded for <strong>{{ today_name }}</strong>.
                            You cannot select a different day. The system automatically knows which day it is.
                        </div>

                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-success btn-lg btn-block">
                                <i class="fas fa-save"></i> Submit Checklist for {{ today_name }}
                            </button>
                            <a href="{% url 'pm_daily_dashboard' %}" class="btn btn-secondary btn-lg btn-block">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('pm-checklist-form').addEventListener('submit', function(e) {
    var printedName = document.getElementById('printed_name').value.trim();
    if (!printedName) {
        e.preventDefault();
        alert('Please enter your printed name before submitting.');
        return false;
    }

    var confirmed = confirm('Are you sure you want to submit this PM checklist for {{ today_name }}?');
    if (!confirmed) {
        e.preventDefault();
        return false;
    }
});
</script>

<style>
    .table-secondary {
        background-color: #e9ecef !important;
    }

    .custom-control-input:checked ~ .custom-control-label i {
        font-size: 1.5em;
    }
</style>
{% endblock %}
