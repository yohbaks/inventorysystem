{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container">
  <div class="page-inner">
    <div class="row">
      <!-- Left Column -->
      <div class="col-md-8">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-tools">
              {% with details=laptop_package.laptop_details.first %}
              {% if details and not details.is_disposed %}
              <button class="btn btn-label-danger btn-round btn-sm me-2" data-bs-toggle="modal" data-bs-target="#disposeModal">
                <span class="btn-label"><i class="fa fa-location-arrow"></i></span> Return to Supply
              </button>
              {% endif %}
              {% endwith %}
              <a href="#" class="btn btn-label-info btn-round btn-sm">
                <span class="btn-label"><i class="fa fa-print"></i></span> Maintenance
              </a>
              <a href="#" class="btn btn-label-success btn-round btn-sm me-2">
                <i class="fa fa-file-pdf"></i> Download PDF
              </a>
              <button type="button" class="btn btn-label-warning btn-round btn-sm" data-bs-toggle="modal" data-bs-target="#qrModal">
                <i class="fas fa-qrcode"></i> Generate QR Code
              </button>
            </div>
          </div>

          <!-- QR Modal -->
          <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Laptop Package QR Code</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                  {% if laptop_package.qr_code %}
                    <img id="qrImage" src="{{ laptop_package.qr_code.url }}" alt="QR Code for Laptop Package {{ laptop_package.pk }}" width="200">
                    <p class="mt-2">Scan to view this laptop package</p>
                    <button class="btn btn-primary mt-3" onclick="printQrCode()">
                      <i class="fa fa-print"></i> Print Wallet-Size QR
                    </button>
                  {% else %}
                    <p>No QR code available.</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <script>
            function printQrCode() {
              const qrImage = document.getElementById("qrImage");
              if (!qrImage) return;
              const printWindow = window.open("", "_blank", "width=400,height=250");
              printWindow.document.write(`
                <html><head><title>Print QR Code</title>
                <style>
                  @page { size: 3.5in 2in; margin: 0; }
                  body { display:flex;align-items:center;justify-content:center;margin:0; }
                  .card { width:1.8in;height:1.8in;border:2px solid black;border-radius:15px;display:flex;flex-direction:column;align-items:center;justify-content:center; }
                  img { width:1.1in;height:1.1in; }
                  .footer { margin-top:6px;font-weight:bold;font-size:14px;text-transform:uppercase; }
                </style></head>
                <body>
                  <div class="card">
                    <img src="${qrImage.src}" alt="QR Code">
                    <div class="footer">DPWH PROPERTY</div>
                  </div>
                  <script>window.onload=function(){window.print();window.close();}<\/script>
                </body></html>
              `);
              printWindow.document.close();
            }
          </script>

          <div class="card-body">
            <!-- Tabs -->
            <ul class="nav nav-pills nav-secondary nav-pills-no-bd nav-pills-icons justify-content-center">
              <li class="nav-item submenu">
                <a class="nav-link active" data-bs-toggle="pill" href="#tab-laptop"><i class="fas fa-laptop"></i> Laptop Details</a>
              </li>
              <li class="nav-item submenu">
                <a class="nav-link" data-bs-toggle="pill" href="#tab-user"><i class="fas fa-user"></i> User Details</a>
              </li>
              <li class="nav-item submenu">
                <a class="nav-link" data-bs-toggle="pill" href="#tab-docs"><i class="fas fa-file-alt"></i> Documents</a>
              </li>
              <li class="nav-item submenu">
                <a class="nav-link" data-bs-toggle="pill" href="#tab-pm"><i class="fas fa-file-alt"></i> PM Schedule</a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="col-md-4">
        <div class="card card-secondary bg-secondary-gradient">
          <div class="card-body curves-shadow">
            <img src="{% static 'img/kaiadmin/logo_light.svg' %}" height="20">
            <h1 class="py-4 mb-0">{{ laptop_package.computer_name }}</h1>
            {% if user_details %}
            <div class="row">
              <div class="col-8 pe-0">
                <h3 class="fw-bold mb-1">{{ user_details.user_Assetowner.full_name }}</h3>
                <div class="text-small text-uppercase fw-bold op-8">
                  {{ user_details.user_Assetowner.employee_position }}
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content mt-2 mb-3">
      <!-- Laptop Specs -->
      <div class="tab-pane fade show active" id="tab-laptop">
        <div class="card">
          <div class="card-header"><div class="card-title">Laptop Details</div></div>
          <div class="card-body">
            {% with details=laptop_package.laptop_details.first %}
              {% if details %}
              <table class="table table-head-bg-success table-bordered table-hover">
                <tbody>
                  <tr><td><strong>Serial Number</strong></td><td>{{ details.laptop_sn_db }}</td></tr>
                  <tr><td><strong>Brand</strong></td><td>{{ details.brand_name }}</td></tr>
                  <tr><td><strong>Model</strong></td><td>{{ details.model }}</td></tr>
                  <tr><td><strong>Processor</strong></td><td>{{ details.processor }}</td></tr>
                  <tr><td><strong>Memory</strong></td><td>{{ details.memory }}</td></tr>
                  <tr><td><strong>Drive</strong></td><td>{{ details.drive }}</td></tr>
                  <tr><td><strong>OS</strong></td><td>{{ details.laptop_OS }}</td></tr>
                  <tr><td><strong>Office</strong></td><td>{{ details.laptop_Office }}</td></tr>
                </tbody>
              </table>
              {% else %}
                <p class="text-muted">No laptop details available.</p>
              {% endif %}
            {% endwith %}
          </div>
        </div>

        <!-- Disposal History -->
        <div class="card mt-3">
          <div class="card-header"><div class="card-title">Disposed History</div></div>
          <div class="card-body">
            {% if disposed_laptops %}
            <table class="table table-head-bg-danger table-bordered table-hover">
              <thead><tr><th>Serial</th><th>Brand</th><th>Model</th><th>Reason</th><th>Date</th></tr></thead>
              <tbody>
                {% for d in disposed_laptops %}
                <tr class="table-danger">
                  <td>{{ d.serial_no }}</td>
                  <td>{{ d.brand_name }}</td>
                  <td>{{ d.model }}</td>
                  <td>{{ d.reason }}</td>
                  <td>{{ d.date_disposed|date:"Y-m-d" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p class="text-muted">No disposal records.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- User -->
      <div class="tab-pane fade" id="tab-user">
        <div class="card">
          <div class="card-header"><div class="card-title">User Details</div></div>
          <div class="card-body">
            {% if user_details %}
            <table class="table table-head-bg-success table-bordered table-hover">
              <tbody>
                <tr>
                  <td><strong>End User</strong></td>
                  <td>
                    {{ user_details.user_Enduser.full_name }}
                    <br>
                    <small class="text-muted">{{ user_details.user_Enduser.employee_position }}</small>
                  </td>
                </tr>
                <tr>
                  <td><strong>Asset Owner</strong></td>
                  <td>
                    {{ user_details.user_Assetowner.full_name }}
                    <br>
                    <small class="text-muted">{{ user_details.user_Assetowner.employee_position }}</small>
                  </td>
                </tr>
              </tbody>
            </table>
            {% else %}
              <p class="text-muted">No user assigned.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Documents -->
      <div class="tab-pane fade" id="tab-docs">
        <div class="card">
          <div class="card-header"><div class="card-title">Documents</div></div>
          <div class="card-body">
            {% if documents_details %}
            <table class="table table-head-bg-success table-bordered table-hover">
              <tbody>
                <tr><td><strong>PAR</strong></td><td>{{ documents_details.docs_PAR }}</td></tr>
                <tr><td><strong>Property No</strong></td><td>{{ documents_details.docs_Propertyno }}</td></tr>
                <tr><td><strong>Value</strong></td><td>{{ documents_details.docs_Value }}</td></tr>
                <tr><td><strong>Date Received</strong></td><td>{{ documents_details.docs_Datereceived }}</td></tr>
                <tr><td><strong>Supplier</strong></td><td>{{ documents_details.docs_Supplier }}</td></tr>
                <tr><td><strong>Status</strong></td><td>{{ documents_details.docs_Status }}</td></tr>
              </tbody>
            </table>
            {% else %}
              <p class="text-muted">No documents found.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- PM Schedule -->
      <div class="tab-pane fade" id="tab-pm">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Preventive Maintenance Schedule</div>
          </div>
          <div class="card-body">
            {% if pm_assignments %}
              <table class="table table-bordered table-hover table-striped">
                <thead class="table-light">
                  <tr>
                    <th>Quarter</th>
                    <th>Section</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Remarks</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for assignment in pm_assignments %}
                    <tr>
                      <td>{{ assignment.pm_section_schedule.quarter_schedule.get_quarter_display }} {{ assignment.pm_section_schedule.quarter_schedule.year }}</td>
                      <td>{{ assignment.pm_section_schedule.section.name }}</td>
                      <td>{{ assignment.pm_section_schedule.start_date|date:"Y-m-d" }}</td>
                      <td>{{ assignment.pm_section_schedule.end_date|date:"Y-m-d" }}</td>
                      <td>{{ assignment.remarks|default:"—" }}</td>
                      <td>
                        {% if assignment.is_completed %}
                          <span class="badge bg-success">Completed</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">Pending</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="text-muted">No PM schedule assigned yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

<!-- Dispose Modal -->
<div class="modal fade" id="disposeModal" tabindex="-1">
  <div class="modal-dialog">
    {% with details=laptop_package.laptop_details.first %}
    {% if details %}
    <form method="POST" action="{% url 'dispose_laptop' details.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Dispose Laptop</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Reason</label>
          <textarea name="reason" class="form-control" required></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Dispose</button>
        </div>
      </div>
    </form>
    {% else %}
      <div class="alert alert-warning m-0">
        ⚠ No active laptop to dispose in this package.
      </div>
    {% endif %}
    {% endwith %}
  </div>
</div>

{% endblock %}
