{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <div class="page-inner">

    <!-- ==================== PREMIUM PAGE HEADER - DANGER THEME (RED) ==================== -->
    <div class="premium-page-header theme-danger">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div class="d-flex align-items-center">
          <div class="premium-page-icon">
            <i class="fa fa-trash-alt"></i>
          </div>
          <div class="ms-3">
            <h4 class="premium-page-title mb-0">Disposal History</h4>
            <p class="text-white mb-0" style="font-size: 0.875rem; opacity: 0.9;">
              Complete history of all disposed equipment
            </p>
          </div>
        </div>
        <div class="d-flex gap-2 mt-3 mt-md-0">
          <a href="#" class="premium-header-btn danger" id="exportBtn">
            <i class="fa fa-download me-1"></i> Export
          </a>
          <a href="#" class="premium-header-btn info" onclick="window.print(); return false;">
            <i class="fa fa-print me-1"></i> Print
          </a>
        </div>
      </div>
    </div>

    <!-- ==================== PREMIUM TABS CARD ==================== -->
    <div class="premium-table-card">
      
      <!-- Premium Tabs Navigation -->
      <div class="premium-tabs-wrapper">
        <ul class="premium-tabs-nav" id="disposal-tabs" role="tablist">
          {% for group in categories %}
          <li class="premium-tab-item">
            <a class="premium-tab-link {% if forloop.first %}active{% endif %}" 
               data-bs-toggle="pill" 
               href="#content-{{ group.category }}">
              {% if group.category == "desktop" %}
                <i class="fa fa-desktop me-2"></i>
              {% elif group.category == "monitor" %}
                <i class="fa fa-tv me-2"></i>
              {% elif group.category == "keyboard" %}
                <i class="fa fa-keyboard me-2"></i>
              {% elif group.category == "mouse" %}
                <i class="fa fa-mouse-pointer me-2"></i>
              {% elif group.category == "ups" %}
                <i class="fa fa-plug me-2"></i>
              {% endif %}
              {{ group.label }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Tab Content -->
      <div class="tab-content premium-table-wrapper" id="disposal-tabContent">

        {% for group in categories %}
        <!-- ==================== {{ group.label|upper }} TAB ==================== -->
        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
             id="content-{{ group.category }}" 
             role="tabpanel">
          <div class="table-responsive">
            <table class="premium-datatable display" 
                   id="table-{{ group.category }}" 
                   style="width:100%">
              <thead>
                <tr>
                  <th>Package #</th>
                  <th>Computer Name</th>
                  <th>Serial No</th>
                  <th>Model</th>
                  <th>Brand</th>
                  <th>Disposed Date</th>
                  <th>Reason</th>
                  <th>Disposed By</th>
                </tr>
                <tr class="filters">
                  <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Package" data-table="{{ group.category }}" data-column="0" /></th>
                  <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Computer" data-table="{{ group.category }}" data-column="1" /></th>
                  <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Serial" data-table="{{ group.category }}" data-column="2" /></th>
                  <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Model" data-table="{{ group.category }}" data-column="3" /></th>
                  <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Brand" data-table="{{ group.category }}" data-column="4" /></th>
                  <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Date" data-table="{{ group.category }}" data-column="5" /></th>
                  <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Reason" data-table="{{ group.category }}" data-column="6" /></th>
                  <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search User" data-table="{{ group.category }}" data-column="7" /></th>
                </tr>
              </thead>
              <tbody>
                {% for item in group.items %}
                <tr>
                  <!-- Package # -->
                  <td>
                    <span class="premium-badge badge-primary">
                      <i class="fa fa-hashtag me-1" style="font-size: 10px;"></i>
                      {% if group.category == "desktop" %}
                        {{ item.desktop.equipment_package.id }}
                      {% else %}
                        {{ item.equipment_package.id|default:"N/A" }}
                      {% endif %}
                    </span>
                  </td>

                  <!-- Computer Name -->
                  <td>
                    <div class="d-flex align-items-center">
                      <div style="width: 32px; height: 32px; border-radius: 6px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); display: flex; align-items: center; justify-content: center; margin-right: 0.5rem;">
                        {% if group.category == "desktop" %}
                          <i class="fa fa-desktop text-white" style="font-size: 14px;"></i>
                        {% elif group.category == "monitor" %}
                          <i class="fa fa-tv text-white" style="font-size: 14px;"></i>
                        {% elif group.category == "keyboard" %}
                          <i class="fa fa-keyboard text-white" style="font-size: 14px;"></i>
                        {% elif group.category == "mouse" %}
                          <i class="fa fa-mouse-pointer text-white" style="font-size: 14px;"></i>
                        {% elif group.category == "ups" %}
                          <i class="fa fa-plug text-white" style="font-size: 14px;"></i>
                        {% endif %}
                      </div>
                      <span class="fw-semibold text-dark">
                        {% if group.category == "desktop" %}
                          {{ item.desktop.computer_name }}
                        {% else %}
                          {{ item.equipment_package.computer_name|default:"N/A" }}
                        {% endif %}
                      </span>
                    </div>
                  </td>

                  <!-- Serial Number -->
                  <td>
                    <span class="text-muted" style="font-family: monospace; font-size: 0.875rem;">
                      {% if group.category == "desktop" %}
                        {{ item.serial_no }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_sn }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_dispose_db.keyboard_sn_db }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_db.mouse_sn_db }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_db.ups_sn_db }}
                      {% else %}
                        N/A
                      {% endif %}
                    </span>
                  </td>

                  <!-- Model -->
                  <td>
                    <span class="text-dark">
                      {% if group.category == "desktop" %}
                        {{ item.model }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_model }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_dispose_db.keyboard_model_db }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_db.mouse_model_db }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_db.ups_model_db }}
                      {% else %}
                        N/A
                      {% endif %}
                    </span>
                  </td>

                  <!-- Brand -->
                  <td>
                    <span class="fw-semibold text-dark">
                      {% if group.category == "desktop" %}
                        {{ item.brand_name }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_brand }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_dispose_db.keyboard_brand_db }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_db.mouse_brand_db }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_db.ups_brand_db }}
                      {% else %}
                        N/A
                      {% endif %}
                    </span>
                  </td>

                  <!-- Disposed Date -->
                  <td>
                    <span class="premium-date-badge danger">
                      <i class="fa fa-calendar-times me-1" style="font-size: 11px;"></i>
                      {% if group.category == "desktop" %}
                        {{ item.date_disposed|date:"M d, Y" }}
                      {% elif group.category == "monitor" %}
                        {{ item.disposal_date|date:"M d, Y" }}
                      {% else %}
                        {{ item.disposal_date|date:"M d, Y" }}
                      {% endif %}
                    </span>
                  </td>

                  <!-- Reason -->
                  <td>
                    <div class="premium-reason-text">
                      {% if group.category == "desktop" %}
                        {{ item.reason|default:"—"|truncatewords:10 }}
                      {% else %}
                        {{ item.reason|default:"—"|truncatewords:10 }}
                      {% endif %}
                    </div>
                  </td>

                  <!-- Disposed By -->
                  <td>
                    <span class="premium-user-badge">
                      <i class="fa fa-user me-1" style="font-size: 10px;"></i>
                      {% if item.disposed_by %}
                        {{ item.disposed_by }}
                      {% else %}
                        System
                      {% endif %}
                    </span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8" class="text-center py-5">
                    <div style="opacity: 0.5;">
                      <i class="fa fa-trash-alt fa-3x text-muted mb-3"></i>
                      <p class="text-muted mb-0">No disposal history</p>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}

      </div>
    </div>

  </div>
</div>

<!-- Custom Styles -->
<style>
/* Premium Badge Styles */
.premium-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.35rem 0.75rem;
  border-radius: 50px;
  font-size: 0.813rem;
  font-weight: 600;
}

.premium-badge.badge-primary {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: white;
}

/* Premium Date Badge - Danger Theme */
.premium-date-badge.danger {
  display: inline-flex;
  align-items: center;
  padding: 0.4rem 0.85rem;
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  color: #991b1b;
  border-radius: 50px;
  font-size: 0.813rem;
  font-weight: 600;
  border: 1px solid #fca5a5;
}

/* Premium User Badge */
.premium-user-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.4rem 0.85rem;
  background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
  color: #3730a3;
  border-radius: 50px;
  font-size: 0.813rem;
  font-weight: 600;
  border: 1px solid #a5b4fc;
}

/* Premium Reason Text */
.premium-reason-text {
  max-width: 250px;
  color: #6b7280;
  font-size: 0.875rem;
  line-height: 1.5;
}

/* Danger Header Theme */
.premium-page-header.theme-danger {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 4px 6px -1px rgba(220, 53, 69, 0.2), 0 2px 4px -1px rgba(220, 53, 69, 0.1);
}

/* Danger Header Button */
.premium-header-btn.danger {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 0.5rem 1.25rem;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 600;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  transition: all 0.3s ease;
}

.premium-header-btn.danger:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.5);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.premium-header-btn.info {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 0.5rem 1.25rem;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 600;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  transition: all 0.3s ease;
}

.premium-header-btn.info:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.5);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Print Styles */
@media print {
  .filters { display: none !important; }
  .premium-page-header { display: none !important; }
  .premium-tabs-wrapper { display: none !important; }
  .dt-buttons { display: none !important; }
}
</style>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
$(document).ready(function() {
  console.log('Initializing Premium Disposal History DataTables...');
  
  // Store table instances
  var tables = {};
  
  // Initialize all DataTables
  {% for group in categories %}
  tables.{{ group.category }} = $('#table-{{ group.category }}').DataTable({
    orderCellsTop: true,
    fixedHeader: false,
    pageLength: 10,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
    language: {
      lengthMenu: "Show _MENU_ entries",
      info: "Showing _START_ to _END_ of _TOTAL_ disposed items",
      infoEmpty: "Showing 0 to 0 of 0 disposed items",
      infoFiltered: "(filtered from _MAX_ total disposed items)",
      paginate: {
        first: '<i class="fa fa-angle-double-left"></i>',
        last: '<i class="fa fa-angle-double-right"></i>',
        next: '<i class="fa fa-angle-right"></i>',
        previous: '<i class="fa fa-angle-left"></i>'
      }
    },
    initComplete: function() {
      console.log('{{ group.category }} DataTable initialized');
      
      // Add animation to rows
      $('#table-{{ group.category }} tbody tr').each(function(index) {
        $(this).css({
          'animation': 'fadeInUp 0.5s ease-out',
          'animation-delay': (index * 0.05) + 's',
          'animation-fill-mode': 'both'
        });
      });
    }
  });
  {% endfor %}
  
  console.log('All DataTables initialized');
  
  // Apply the search using data-column and data-table attributes
  $('.column-search').on('keyup change', function() {
    var tableName = $(this).data('table');
    var columnIndex = $(this).data('column');
    var searchValue = this.value;
    
    console.log('Searching ' + tableName + ' table, column ' + columnIndex + ' for: ' + searchValue);
    
    if (tables[tableName]) {
      tables[tableName].column(columnIndex).search(searchValue).draw();
    }
  });
  
  // Recalculate table dimensions when switching tabs (Bootstrap handler)
  $('[data-bs-toggle="pill"]').on('shown.bs.tab', function(e) {
    console.log('Tab switched:', e.target);
    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
  });
  
  // Manual tab click handler (backup for Bootstrap conflicts)
  $('.premium-tab-link').on('click', function(e) {
    e.preventDefault();
    
    var targetId = $(this).attr('href');
    console.log('Manual tab click:', targetId);
    
    // Remove active from all tabs
    $('.premium-tab-link').removeClass('active');
    
    // Add active to clicked tab
    $(this).addClass('active');
    
    // Hide all tab panes
    $('.tab-pane').removeClass('show active');
    
    // Show target pane
    $(targetId).addClass('show active');
    
    // Adjust DataTable columns
    setTimeout(function() {
      $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
    }, 100);
    
    return false;
  });
  
  console.log('Filter handlers and manual tab handlers attached');
});

// Add fade-in animation keyframes
if (!document.querySelector('#fadeInUpKeyframes')) {
  var style = document.createElement('style');
  style.id = 'fadeInUpKeyframes';
  style.textContent = `
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  `;
  document.head.appendChild(style);
}
</script>
{% endblock %}