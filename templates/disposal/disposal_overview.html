{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <div class="page-inner">

    <!-- ==================== PREMIUM PAGE HEADER - DANGER THEME (RED) ==================== -->
    <div class="premium-page-header theme-danger">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div class="d-flex align-items-center">
          <div class="premium-page-icon">
            <i class="fa fa-trash-alt"></i>
          </div>
          <div class="ms-3">
            <h4 class="premium-page-title mb-0">Disposal Overview</h4>
            <p class="text-white mb-0" style="font-size: 0.875rem; opacity: 0.9;">
              Track and manage disposed equipment across all categories
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== PREMIUM TABS CARD ==================== -->
    <div class="premium-table-card">
      
      <!-- Premium Tabs Navigation -->
      <div class="premium-tabs-wrapper">
        <ul class="premium-tabs-nav" id="disposal-tabs" role="tablist">
          {% for group in categories %}
          <li class="premium-tab-item">
            <a class="premium-tab-link {% if forloop.first %}active{% endif %}" 
               data-bs-toggle="pill" 
               href="#content-{{ group.category }}">
              {% if group.category == "desktop" %}
                <i class="fa fa-desktop me-2"></i>
              {% elif group.category == "monitor" %}
                <i class="fa fa-tv me-2"></i>
              {% elif group.category == "keyboard" %}
                <i class="fa fa-keyboard me-2"></i>
              {% elif group.category == "mouse" %}
                <i class="fa fa-mouse-pointer me-2"></i>
              {% elif group.category == "ups" %}
                <i class="fa fa-plug me-2"></i>
              {% endif %}
              {{ group.label }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Tab Content -->
      <div class="tab-content premium-table-wrapper" id="disposal-tabs-content">
        {% for group in categories %}
        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
             id="content-{{ group.category }}" 
             role="tabpanel">
          
          <div class="table-responsive">
            <table class="premium-datatable display" 
                   id="table-{{ group.category }}"
                   data-report-title="Disposal Report - {{ group.label }}"
                   style="width:100%">
              <thead>
                <!-- Header Row -->
                <tr>
                  <th>Package #</th>
                  <th>Computer Name</th>
                  <th>Serial No</th>
                  <th>Model</th>
                  <th>Brand</th>
                  <th>Disposed Date</th>
                  <th>Reason</th>
                </tr>
                
                <!-- Filter Row -->
                <tr class="filters">
                  <th>
                    <input type="text" 
                           class="form-control form-control-sm column-search" 
                           placeholder="Search Package" 
                           data-table="{{ group.category }}" 
                           data-column="0" />
                  </th>
                  <th>
                    <input type="text" 
                           class="form-control form-control-sm column-search" 
                           placeholder="Search Computer" 
                           data-table="{{ group.category }}" 
                           data-column="1" />
                  </th>
                  <th>
                    <input type="text" 
                           class="form-control form-control-sm column-search" 
                           placeholder="Search Serial" 
                           data-table="{{ group.category }}" 
                           data-column="2" />
                  </th>
                  <th>
                    <input type="text" 
                           class="form-control form-control-sm column-search" 
                           placeholder="Search Model" 
                           data-table="{{ group.category }}" 
                           data-column="3" />
                  </th>
                  <th>
                    <input type="text" 
                           class="form-control form-control-sm column-search" 
                           placeholder="Search Brand" 
                           data-table="{{ group.category }}" 
                           data-column="4" />
                  </th>
                  <th>
                    <input type="text" 
                           class="form-control form-control-sm column-search" 
                           placeholder="Search Date" 
                           data-table="{{ group.category }}" 
                           data-column="5" />
                  </th>
                  <th>
                    <input type="text" 
                           class="form-control form-control-sm column-search" 
                           placeholder="Search Reason" 
                           data-table="{{ group.category }}" 
                           data-column="6" />
                  </th>
                </tr>
              </thead>
              
              <tbody>
                {% for item in group.items %}
                <tr>
                  <td>
                    <span class="premium-package-badge">
                      <i class="fa fa-hashtag me-1" style="font-size: 10px;"></i>
                      {% if group.category == "desktop" %}
                        {{ item.desktop.equipment_package.id }}
                      {% else %}
                        {{ item.equipment_package.id|default:"N/A" }}
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <span class="fw-semibold text-dark">
                      {% if group.category == "desktop" %}
                        {{ item.desktop.computer_name }}
                      {% else %}
                        {{ item.equipment_package.computer_name|default:"N/A" }}
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <span class="text-muted" style="font-family: monospace; font-size: 0.875rem;">
                      {% if group.category == "desktop" %}
                        {{ item.serial_no|default:"N/A" }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_sn|default:"N/A" }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_sn_db|default:"N/A" }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_sn_db|default:"N/A" }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_sn_db|default:"N/A" }}
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <span class="text-dark">
                      {% if group.category == "desktop" %}
                        {{ item.model|default:"N/A" }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_model|default:"N/A" }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_model_db|default:"N/A" }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_model_db|default:"N/A" }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_model_db|default:"N/A" }}
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <span class="fw-semibold text-dark">
                      {% if group.category == "desktop" %}
                        {{ item.brand_name|default:"N/A" }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_brand|default:"N/A" }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_brand_db|default:"N/A" }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_brand_db|default:"N/A" }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_brand_db|default:"N/A" }}
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <span class="premium-date-badge">
                      <i class="fa fa-calendar-times me-1" style="font-size: 11px;"></i>
                      {% if group.category == "desktop" %}
                        {{ item.date_disposed|date:"M d, Y"|default:"N/A" }}
                      {% else %}
                        {{ item.disposal_date|date:"M d, Y"|default:"N/A" }}
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <div class="premium-reason-text">
                      {% if group.category == "desktop" %}
                        {{ item.reason|default:"N/A" }}
                      {% else %}
                        {{ item.notes|default:"N/A" }}
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="7" class="text-center py-5">
                    <div style="opacity: 0.5;">
                      <i class="fa fa-trash-alt fa-3x text-muted mb-3"></i>
                      <p class="text-muted mb-0">No disposed items in this category</p>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
        </div>
        {% endfor %}
      </div>
      
    </div>

  </div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
$(document).ready(function() {
  console.log('Initializing Premium Disposal DataTables...');
  
  // Store table instances
  var tables = {};
  
  // Initialize all DataTables with export buttons
  {% for group in categories %}
  tables.{{ group.category }} = $('#table-{{ group.category }}').DataTable({
    orderCellsTop: true,
    fixedHeader: false,
    pageLength: 10,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
    dom: "<'row mb-3'<'col-md-6'l><'col-md-6 text-end'B>>" +
         "<'row'<'col-12'tr>>" +
         "<'row mt-3'<'col-md-5'i><'col-md-7'p>>",
    buttons: [
      { 
        extend: 'excel', 
        className: 'btn btn-success btn-sm me-1', 
        text: '<i class="fa fa-file-excel me-1"></i> Excel',
        title: 'Disposal Report - {{ group.label }}',
        exportOptions: {
          columns: ':not(.no-export)'
        }
      },
      { 
        extend: 'pdf', 
        className: 'btn btn-danger btn-sm me-1', 
        text: '<i class="fa fa-file-pdf me-1"></i> PDF',
        title: 'Disposal Report - {{ group.label }}',
        exportOptions: {
          columns: ':not(.no-export)'
        }
      },
      { 
        extend: 'csv', 
        className: 'btn btn-info btn-sm me-1', 
        text: '<i class="fa fa-file-csv me-1"></i> CSV',
        title: 'Disposal Report - {{ group.label }}',
        exportOptions: {
          columns: ':not(.no-export)'
        }
      },
      { 
        extend: 'print', 
        className: 'btn btn-primary btn-sm', 
        text: '<i class="fa fa-print me-1"></i> Print',
        title: 'Disposal Report - {{ group.label }}',
        exportOptions: {
          columns: ':not(.no-export)'
        }
      }
    ],
    language: {
      lengthMenu: "Show _MENU_ entries",
      info: "Showing _START_ to _END_ of _TOTAL_ items",
      infoEmpty: "Showing 0 to 0 of 0 items",
      infoFiltered: "(filtered from _MAX_ total items)",
      zeroRecords: "No matching disposal records found",
      emptyTable: "No disposed items available",
      paginate: {
        first: '<i class="fa fa-angle-double-left"></i>',
        last: '<i class="fa fa-angle-double-right"></i>',
        next: '<i class="fa fa-angle-right"></i>',
        previous: '<i class="fa fa-angle-left"></i>'
      }
    },
    initComplete: function() {
      console.log('DataTable for {{ group.category }} initialized');
      
      // Add animation to rows
      $('#table-{{ group.category }} tbody tr').each(function(index) {
        $(this).css({
          'animation': 'fadeInUp 0.5s ease-out',
          'animation-delay': (index * 0.05) + 's',
          'animation-fill-mode': 'both'
        });
      });
    }
  });
  {% endfor %}
  
  console.log('All DataTables initialized');
  
  // Apply the search using data-column and data-table attributes
  $('.column-search').on('keyup change', function() {
    var tableName = $(this).data('table');
    var columnIndex = $(this).data('column');
    var searchValue = this.value;
    
    console.log('Searching ' + tableName + ' table, column ' + columnIndex + ' for: ' + searchValue);
    
    if (tables[tableName]) {
      tables[tableName].column(columnIndex).search(searchValue).draw();
    }
  });
  
  // Recalculate table dimensions when switching tabs
  $('[data-bs-toggle="pill"]').on('shown.bs.tab', function(e) {
    console.log('Tab switched:', e.target);
    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
  });
  
  // Manual tab click handler (backup for Bootstrap conflicts)
  $('.premium-tab-link').on('click', function(e) {
    e.preventDefault();
    
    var targetId = $(this).attr('href');
    console.log('Manual tab click:', targetId);
    
    // Remove active from all tabs
    $('.premium-tab-link').removeClass('active');
    
    // Add active to clicked tab
    $(this).addClass('active');
    
    // Hide all tab panes
    $('.tab-pane').removeClass('show active');
    
    // Show target pane
    $(targetId).addClass('show active');
    
    // Adjust DataTable columns
    setTimeout(function() {
      $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
    }, 100);
    
    return false;
  });
  
  console.log('Filter handlers and manual tab handlers attached');
});

// Add fade-in animation keyframes
if (!document.querySelector('#fadeInUpKeyframes')) {
  var style = document.createElement('style');
  style.id = 'fadeInUpKeyframes';
  style.textContent = `
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  `;
  document.head.appendChild(style);
}
</script>

<!-- Hide filter row in print -->
<style>
  @media print {
    .filters { display: none !important; }
    .dt-buttons { display: none !important; }
    .premium-page-header { display: none !important; }
    .premium-tabs-wrapper { display: none !important; }
  }
</style>
{% endblock %}