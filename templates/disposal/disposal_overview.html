{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container">
  <div class="page-inner">
    
    <!-- Page Title -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-bold text-primary mb-0">
        <i class="fas fa-trash-alt me-2"></i> Disposal Overview
      </h3>
    </div>

    <!-- Pills Navigation -->
    <ul class="nav nav-pills nav-line nav-color-secondary mb-4" id="disposal-tabs" role="tablist">
      {% for group in categories %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if forloop.first %}active{% endif %}" 
                id="tab-{{ group.category }}" 
                data-bs-toggle="pill" 
                data-bs-target="#content-{{ group.category }}" 
                type="button" role="tab">
          {% if group.category == "desktop" %}<i class="fas fa-desktop me-1"></i>{% endif %}
          {% if group.category == "monitor" %}<i class="fas fa-tv me-1"></i>{% endif %}
          {% if group.category == "keyboard" %}<i class="fas fa-keyboard me-1"></i>{% endif %}
          {% if group.category == "mouse" %}<i class="fas fa-mouse me-1"></i>{% endif %}
          {% if group.category == "ups" %}<i class="fas fa-plug me-1"></i>{% endif %}
          {{ group.label }}
        </button>
      </li>
      {% endfor %}
    </ul>

    <!-- Pills Content -->
    <div class="tab-content" id="disposal-tabs-content">
      {% for group in categories %}
      <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
           id="content-{{ group.category }}" role="tabpanel">
        <div class="card shadow-sm border-0 mb-4">
          <!-- 🔴 Red Header with White Text -->
          <div class="card-header rounded-top" style="background-color:#e74c3c;">
            <h4 class="card-title fw-bold mb-0 text-white">
              <i class="fas fa-database me-2 text-white"></i> {{ group.label }} Disposal Records
            </h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle w-100 exportable" 
                     id="table-{{ group.category }}"
                     data-report-title="Disposal Report - {{ group.label }}">
                <thead>
                  <tr style="background-color:#e74c3c; color:white;">
                    <th>Package #</th>
                    <th>Computer Name</th>
                    <th>Serial No</th>
                    <th>Model</th>
                    <th>Brand</th>
                    <th>Disposed Date</th>
                    <th>Reason</th>
                  </tr>
                  <!-- Filter row -->
                  <tr class="bg-light text-dark filter-row">
                    <th><input type="text" placeholder="🔍 Package" class="form-control form-control-sm" /></th>
                    <th><input type="text" placeholder="🔍 Computer" class="form-control form-control-sm" /></th>
                    <th><input type="text" placeholder="🔍 Serial" class="form-control form-control-sm" /></th>
                    <th><input type="text" placeholder="🔍 Model" class="form-control form-control-sm" /></th>
                    <th><input type="text" placeholder="🔍 Brand" class="form-control form-control-sm" /></th>
                    <th><input type="text" placeholder="🔍 Date" class="form-control form-control-sm" /></th>
                    <th><input type="text" placeholder="🔍 Reason" class="form-control form-control-sm" /></th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in group.items %}
                  <tr>
                    <td>{% if group.category == "desktop" %}{{ item.desktop.equipment_package.id }}{% else %}{{ item.equipment_package.id|default:"N/A" }}{% endif %}</td>
                    <td>{% if group.category == "desktop" %}{{ item.desktop.computer_name }}{% else %}{{ item.equipment_package.computer_name|default:"N/A" }}{% endif %}</td>
                    <td>
                      {% if group.category == "desktop" %}
                        {{ item.serial_no|default:"N/A" }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_sn|default:"N/A" }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_sn_db|default:"N/A" }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_sn_db|default:"N/A" }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_sn_db|default:"N/A" }}
                      {% endif %}
                    </td>
                    <td>
                      {% if group.category == "desktop" %}
                        {{ item.model|default:"N/A" }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_model|default:"N/A" }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_model_db|default:"N/A" }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_model_db|default:"N/A" }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_model_db|default:"N/A" }}
                      {% endif %}
                    </td>
                    <td>
                      {% if group.category == "desktop" %}
                        {{ item.brand_name|default:"N/A" }}
                      {% elif group.category == "monitor" %}
                        {{ item.monitor_brand|default:"N/A" }}
                      {% elif group.category == "keyboard" %}
                        {{ item.keyboard_brand_db|default:"N/A" }}
                      {% elif group.category == "mouse" %}
                        {{ item.mouse_brand_db|default:"N/A" }}
                      {% elif group.category == "ups" %}
                        {{ item.ups_brand_db|default:"N/A" }}
                      {% endif %}
                    </td>
                    <td>
                      {% if group.category == "desktop" %}
                        {{ item.date_disposed|date:"Y-m-d"|default:"N/A" }}
                      {% else %}
                        {{ item.disposal_date|date:"Y-m-d"|default:"N/A" }}
                      {% endif %}
                    </td>
                    <td>
                      {% if group.category == "desktop" %}
                        {{ item.reason|default:"N/A" }}
                      {% else %}
                        {{ item.notes|default:"N/A" }}
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="7" class="text-center text-muted">No disposed items</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ✅ Force load DataTables Buttons from CDN only on this page -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css"/>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

<!-- DataTables + Export Buttons Script -->
<script>
$(function () {
  $('table.exportable').each(function () {
    var $table = $(this);
    var title = $table.data('report-title') || 'Disposal Report';

    var dt = $table.DataTable({
      pageLength: 10,
      responsive: true,
      fixedHeader: true,
      orderCellsTop: true,
      dom: "<'row mb-3'<'col-md-6'l><'col-md-6 text-end'B>>" +
           "<'row'<'col-12'tr>>" +
           "<'row mt-3'<'col-md-5'i><'col-md-7'p>>",
      buttons: [
        { extend: 'excel', className: 'btn btn-success btn-sm me-1', title: title },
        { extend: 'pdf',   className: 'btn btn-danger btn-sm me-1',  title: title },
        { extend: 'csv',   className: 'btn btn-info btn-sm me-1',    title: title },
        { extend: 'print', className: 'btn btn-primary btn-sm',      title: title }
      ]
    });

    // Column filters (second header row)
    $table.find('thead tr:eq(1) th').each(function (i) {
      $('input', this).on('keyup change', function () {
        if (dt.column(i).search() !== this.value) {
          dt.column(i).search(this.value).draw();
        }
      });
    });
  });

  $('[data-bs-toggle="tab"],[data-bs-toggle="pill"]').on('shown.bs.tab', function () {
    $($.fn.dataTable.tables(true)).DataTable().columns.adjust().responsive.recalc();
  });
});
</script>

<!-- Hide filter row in print -->
<style>
  @media print {
    .filter-row { display: none !important; }
    .dt-buttons { display: none !important; }
  }
</style>
{% endblock %}
