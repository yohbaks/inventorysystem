{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <h4 class="card-title"><i class="fas fa-trash-alt me-2"></i> Disposal Overview</h4>
              <div class="ms-auto">
                <!-- Export buttons will be added by DataTables -->
              </div>
            </div>
          </div>

          <div class="card-body">
            <!-- Nav Pills -->
            <ul class="nav nav-pills nav-secondary mb-3" id="disposal-tabs" role="tablist">
              {% for group in categories %}
              <li class="nav-item submenu">
                <a class="nav-link {% if forloop.first %}active{% endif %}" 
                   data-bs-toggle="pill" 
                   href="#content-{{ group.category }}">
                  {% if group.category == "desktop" %}<i class="fas fa-desktop me-1"></i>{% endif %}
                  {% if group.category == "monitor" %}<i class="fas fa-tv me-1"></i>{% endif %}
                  {% if group.category == "keyboard" %}<i class="fas fa-keyboard me-1"></i>{% endif %}
                  {% if group.category == "mouse" %}<i class="fas fa-mouse me-1"></i>{% endif %}
                  {% if group.category == "ups" %}<i class="fas fa-plug me-1"></i>{% endif %}
                  {{ group.label }}
                </a>
              </li>
              {% endfor %}
            </ul>

            <div class="tab-content mt-2" id="disposal-tabs-content">
              {% for group in categories %}
              <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                   id="content-{{ group.category }}" role="tabpanel">
                <div class="table-responsive table-head-bg-primary">
                  <table class="display table table-striped table-hover" 
                         id="table-{{ group.category }}"
                         data-report-title="Disposal Report - {{ group.label }}"
                         style="width:100%">
                    <thead>
                      <tr>
                        <th>Package #</th>
                        <th>Computer Name</th>
                        <th>Serial No</th>
                        <th>Model</th>
                        <th>Brand</th>
                        <th>Disposed Date</th>
                        <th>Reason</th>
                      </tr>
                      <tr class="filters">
                        <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Package" data-table="{{ group.category }}" data-column="0" /></th>
                        <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Computer" data-table="{{ group.category }}" data-column="1" /></th>
                        <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Serial" data-table="{{ group.category }}" data-column="2" /></th>
                        <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Model" data-table="{{ group.category }}" data-column="3" /></th>
                        <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Brand" data-table="{{ group.category }}" data-column="4" /></th>
                        <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Date" data-table="{{ group.category }}" data-column="5" /></th>
                        <th><input type="text" class="form-control form-control-sm column-search" placeholder="Search Reason" data-table="{{ group.category }}" data-column="6" /></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in group.items %}
                      <tr>
                        <td>{% if group.category == "desktop" %}{{ item.desktop.equipment_package.id }}{% else %}{{ item.equipment_package.id|default:"N/A" }}{% endif %}</td>
                        <td>{% if group.category == "desktop" %}{{ item.desktop.computer_name }}{% else %}{{ item.equipment_package.computer_name|default:"N/A" }}{% endif %}</td>
                        <td>
                          {% if group.category == "desktop" %}
                            {{ item.serial_no|default:"N/A" }}
                          {% elif group.category == "monitor" %}
                            {{ item.monitor_sn|default:"N/A" }}
                          {% elif group.category == "keyboard" %}
                            {{ item.keyboard_sn_db|default:"N/A" }}
                          {% elif group.category == "mouse" %}
                            {{ item.mouse_sn_db|default:"N/A" }}
                          {% elif group.category == "ups" %}
                            {{ item.ups_sn_db|default:"N/A" }}
                          {% endif %}
                        </td>
                        <td>
                          {% if group.category == "desktop" %}
                            {{ item.model|default:"N/A" }}
                          {% elif group.category == "monitor" %}
                            {{ item.monitor_model|default:"N/A" }}
                          {% elif group.category == "keyboard" %}
                            {{ item.keyboard_model_db|default:"N/A" }}
                          {% elif group.category == "mouse" %}
                            {{ item.mouse_model_db|default:"N/A" }}
                          {% elif group.category == "ups" %}
                            {{ item.ups_model_db|default:"N/A" }}
                          {% endif %}
                        </td>
                        <td>
                          {% if group.category == "desktop" %}
                            {{ item.brand_name|default:"N/A" }}
                          {% elif group.category == "monitor" %}
                            {{ item.monitor_brand|default:"N/A" }}
                          {% elif group.category == "keyboard" %}
                            {{ item.keyboard_brand_db|default:"N/A" }}
                          {% elif group.category == "mouse" %}
                            {{ item.mouse_brand_db|default:"N/A" }}
                          {% elif group.category == "ups" %}
                            {{ item.ups_brand_db|default:"N/A" }}
                          {% endif %}
                        </td>
                        <td>
                          {% if group.category == "desktop" %}
                            {{ item.date_disposed|date:"Y-m-d"|default:"N/A" }}
                          {% else %}
                            {{ item.disposal_date|date:"Y-m-d"|default:"N/A" }}
                          {% endif %}
                        </td>
                        <td>
                          {% if group.category == "desktop" %}
                            {{ item.reason|default:"N/A" }}
                          {% else %}
                            {{ item.notes|default:"N/A" }}
                          {% endif %}
                        </td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="7" class="text-center text-muted">No disposed items</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
$(document).ready(function() {
  console.log('Initializing Disposal DataTables...');
  
  // Store table instances
  var tables = {};
  
  // Initialize all DataTables with export buttons
  {% for group in categories %}
  tables.{{ group.category }} = $('#table-{{ group.category }}').DataTable({
    orderCellsTop: true,
    fixedHeader: false,
    pageLength: 10,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
    dom: "<'row mb-3'<'col-md-6'l><'col-md-6 text-end'B>>" +
         "<'row'<'col-12'tr>>" +
         "<'row mt-3'<'col-md-5'i><'col-md-7'p>>",
    buttons: [
      { 
        extend: 'excel', 
        className: 'btn btn-success btn-sm me-1', 
        text: '<i class="fa fa-file-excel me-1"></i> Excel',
        title: 'Disposal Report - {{ group.label }}',
        exportOptions: {
          columns: ':not(.no-export)'
        }
      },
      { 
        extend: 'pdf', 
        className: 'btn btn-danger btn-sm me-1', 
        text: '<i class="fa fa-file-pdf me-1"></i> PDF',
        title: 'Disposal Report - {{ group.label }}',
        exportOptions: {
          columns: ':not(.no-export)'
        }
      },
      { 
        extend: 'csv', 
        className: 'btn btn-info btn-sm me-1', 
        text: '<i class="fa fa-file-csv me-1"></i> CSV',
        title: 'Disposal Report - {{ group.label }}',
        exportOptions: {
          columns: ':not(.no-export)'
        }
      },
      { 
        extend: 'print', 
        className: 'btn btn-primary btn-sm', 
        text: '<i class="fa fa-print me-1"></i> Print',
        title: 'Disposal Report - {{ group.label }}',
        exportOptions: {
          columns: ':not(.no-export)'
        }
      }
    ],
    language: {
      lengthMenu: "Show _MENU_ entries",
      info: "Showing _START_ to _END_ of _TOTAL_ items",
      infoEmpty: "Showing 0 to 0 of 0 items",
      infoFiltered: "(filtered from _MAX_ total items)"
    }
  });
  {% endfor %}
  
  console.log('DataTables initialized');
  
  // Apply the search using data-column and data-table attributes
  $('.column-search').on('keyup change', function() {
    var tableName = $(this).data('table');
    var columnIndex = $(this).data('column');
    var searchValue = this.value;
    
    console.log('Searching ' + tableName + ' table, column ' + columnIndex + ' for: ' + searchValue);
    
    if (tables[tableName]) {
      tables[tableName].column(columnIndex).search(searchValue).draw();
    }
  });
  
  // Recalculate table dimensions when switching tabs
  $('[data-bs-toggle="pill"]').on('shown.bs.tab', function() {
    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
  });
  
  console.log('Filter handlers attached');
});
</script>

<!-- Hide filter row in print -->
<style>
  @media print {
    .filters { display: none !important; }
    .dt-buttons { display: none !important; }
  }
</style>
{% endblock %}