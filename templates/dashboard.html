{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <!-- Header -->
    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
      <div>
        <h3 class="fw-bold mb-1">Dashboard</h3>
        <p class="text-muted mb-0">Asset Sync Inventory System V3</p>
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <a href="{% url 'add_equipment_package_with_details' %}" class="btn btn-primary btn-round">
          <i class="fas fa-plus me-1"></i> Add Item
        </a>
      </div>
    </div>

    <!-- KPI Row 1 -->
    <div class="row g-3 mb-3">
      <!-- Total Packages -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-primary card-round shadow-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-5">
                <div class="icon-big text-center">
                  <i class="fas fa-boxes"></i>
                </div>
              </div>
              <div class="col-7 col-stats text-center">
                <div class="numbers">
                  <p class="card-category mb-0">Total Packages</p>
                  <h4 class="card-title mb-0">{{ kpis.total_packages }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Packages -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-success card-round shadow-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-5">
                <div class="icon-big text-center">
                  <i class="far fa-check-circle"></i>
                </div>
              </div>
              <div class="col-7 col-stats text-center">
                <div class="numbers">
                  <p class="card-category mb-0">Active Packages</p>
                  <h4 class="card-title mb-0">{{ kpis.active_packages }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Disposed (All) -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-danger card-round shadow-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-5">
                <div class="icon-big text-center">
                  <i class="far fa-trash-alt"></i>
                </div>
              </div>
              <div class="col-7 col-stats text-center">
                <div class="numbers">
                  <p class="card-category mb-0">Disposed (All)</p>
                  <h4 class="card-title mb-0">{{ kpis.disposed_all }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pending PM -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-info card-round shadow-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-5">
                <div class="icon-big text-center">
                  <i class="far fa-calendar-alt"></i>
                </div>
              </div>
              <div class="col-7 col-stats text-center">
                <div class="numbers">
                  <p class="card-category mb-0">Pending PM</p>
                  <h4 class="card-title mb-0">{{ kpis.pm_pending }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI Row 2 - Equipment Categories -->
    <div class="row g-3 mb-3">
      <!-- Desktops -->
      <div class="col-sm-6 col-md-2">
        <div class="card shadow-sm border-0 text-center">
          <div class="card-body py-3">
            <i class="fas fa-desktop fa-2x text-primary mb-2"></i>
            <p class="fw-bold text-muted small mb-1">Desktops</p>
            <h5 class="fw-bold text-dark mb-0">{{ kpis.total_desktops }}</h5>
          </div>
        </div>
      </div>

      <!-- Laptops -->
      <div class="col-sm-6 col-md-2">
        <div class="card shadow-sm border-0 text-center">
          <div class="card-body py-3">
            <i class="fas fa-laptop fa-2x text-info mb-2"></i>
            <p class="fw-bold text-muted small mb-1">Laptops</p>
            <h5 class="fw-bold text-dark mb-0">{{ kpis.total_laptops }}</h5>
          </div>
        </div>
      </div>

      <!-- Printers -->
      <div class="col-sm-6 col-md-2">
        <div class="card shadow-sm border-0 text-center">
          <div class="card-body py-3">
            <i class="fas fa-print fa-2x text-purple mb-2"></i>
            <p class="fw-bold text-muted small mb-1">Printers</p>
            <h5 class="fw-bold text-dark mb-0">{{ kpis.total_printers }}</h5>
          </div>
        </div>
      </div>

      <!-- UPS -->
      <div class="col-sm-6 col-md-2">
        <div class="card shadow-sm border-0 text-center">
          <div class="card-body py-3">
            <i class="fas fa-plug fa-2x text-warning mb-2"></i>
            <p class="fw-bold text-muted small mb-1">UPS Units</p>
            <h5 class="fw-bold text-dark mb-0">{{ kpis.total_ups }}</h5>
          </div>
        </div>
      </div>

      <!-- Monitors -->
      <div class="col-sm-6 col-md-2">
        <div class="card shadow-sm border-0 text-center">
          <div class="card-body py-3">
            <i class="fas fa-tv fa-2x text-secondary mb-2"></i>
            <p class="fw-bold text-muted small mb-1">Monitors</p>
            <h5 class="fw-bold text-dark mb-0">{{ kpis.total_monitors|default:"0" }}</h5>
          </div>
        </div>
      </div>

      <!-- Health Score -->
      <div class="col-sm-6 col-md-2">
        <div class="card shadow-sm border-0 text-center">
          <div class="card-body py-3">
            <i class="fas fa-heartbeat fa-2x text-success mb-2"></i>
            <p class="fw-bold text-muted small mb-1">Health Score</p>
            <h5 class="fw-bold text-dark mb-0">{{ kpis.health_score }}%</h5>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row g-3 mb-3">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="card-title mb-0">Disposal Trend (Last {{ charts.months }} Months)</h5>
          </div>
          <div class="card-body">
            <div class="chart-container" style="height: 320px;">
              <canvas id="disposalTrendChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="card-title mb-0">Disposed by Category</h5>
          </div>
          <div class="card-body">
            <div class="chart-container" style="height: 320px;">
              <canvas id="disposedByCategoryChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row g-3 mb-3">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="card-title mb-0">Active vs Disposed by Category</h5>
          </div>
          <div class="card-body">
            <div class="chart-container" style="height: 300px;">
              <canvas id="activeDisposedStacked"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="card-title mb-0">Top 5 Brands</h5>
          </div>
          <div class="card-body">
            <div class="chart-container" style="height: 300px;">
              <canvas id="brandChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row g-3 mb-3">
      <div class="col-lg-12">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="card-title mb-0">Assets by Office Section</h5>
          </div>
          <div class="card-body">
            <div class="chart-container" style="height: 400px;">
              <canvas id="sectionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity & Audit Trail -->
    <div class="row g-3 mb-3">
      <!-- Recently Added -->
      <div class="col-xl-6">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="card-title mb-0">Recently Added IT Equipment</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-items-center mb-0">
                <thead class="thead-light">
                  <tr>
                    <th>Computer Name</th>
                    <th>Serial</th>
                    <th>Brand</th>
                    <th>Model</th>
                    <th>Created</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in recent %}
                  <tr>
                    <td class="fw-bold">{{ d.computer_name }}</td>
                    <td>{{ d.serial_no }}</td>
                    <td>{{ d.brand_name }}</td>
                    <td>{{ d.model }}</td>
                    <td>{{ d.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="text-center">
                      <a href="{% url 'desktop_details_view' d.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fa fa-eye"></i> View
                      </a>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="6" class="text-muted text-center py-4">No recent items</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Audit Trail & Upcoming PM -->
      <div class="col-xl-6">
        <!-- Audit Trail -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h5 class="card-title mb-0">Audit Trail (Latest Changes)</h5>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              {% for ev in audit %}
              <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                <div class="ms-2 me-auto">
                  <div class="fw-bold">{{ ev.type }}</div>
                  <small class="text-muted">{{ ev.text|safe }}</small>
                </div>
                <span class="badge bg-light text-muted rounded-pill">{{ ev.when }}</span>
              </li>
              {% empty %}
              <li class="list-group-item text-muted text-center py-3">No recent changes</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Upcoming PM -->
        <div class="card shadow-sm">
          <div class="card-header bg-warning bg-opacity-10">
            <h5 class="card-title mb-0 text-dark">
              <i class="fa fa-calendar-alt me-2"></i> Upcoming PM (7 Days)
            </h5>
          </div>
          <div class="card-body">
            {% if pm_upcoming %}
              {% for pm in pm_upcoming %}
              <div class="d-flex align-items-center mb-3">
                 <div class="avatar">
                    {% if pm.section|lower == "administrative section" %}
                      <img src="{% static '/img/logo_administrative_section.svg' %}" alt="Administrative" class="avatar-img rounded-circle">
                    {% elif pm.section|lower == "commission on audit" %}
                      <img src="{% static '/img/logo_commission_on_audit.svg' %}" alt="COA" class="avatar-img rounded-circle">
                    {% elif pm.section|lower == "planning section" %}
                      <img src="{% static '/img/logoproduct3.svg' %}" alt="Planning" class="avatar-img rounded-circle">
                    {% elif pm.section|lower == "ict section" %}
                      <img src="{% static '/img/logoproduct4.svg' %}" alt="ICT" class="avatar-img rounded-circle">
                    {% elif pm.section|lower == "construction section" %}
                      <img src="{% static '/img/cons-circle.svg' %}" alt="Construction" class="avatar-img rounded-circle">
                    {% else %}
                      <img src="{% static '/img/defaulticon.svg' %}" alt="Other Section" class="avatar-img rounded-circle">
                    {% endif %}
                  </div>
                <div class="flex-1 ms-3">
                  <h6 class="fw-bold mb-1 text-dark">{{ pm.computer_name }}</h6>
                  <small class="text-muted">
                    <i class="fa fa-building me-1"></i> {{ pm.section }} | 
                    <i class="fa fa-clock me-1"></i> {{ pm.range }}
                  </small>
                </div>
                <div class="ms-auto">
                  <span class="badge bg-warning text-dark px-3 py-2">
                    <i class="fa fa-exclamation-circle me-1"></i> Due
                  </span>
                </div>
              </div>
              {% if not forloop.last %}
              <hr class="my-2">
              {% endif %}
              {% endfor %}
            {% else %}
              <div class="text-center text-muted py-4">
                <i class="fa fa-info-circle fa-2x mb-2 d-block"></i>
                <p class="mb-0">No upcoming schedules this week</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
// ========= Chart Data =========
const DISP_LABELS = {{ charts.labels|safe }};
const DISP_DESKTOP = {{ charts.desktop|safe }};
const DISP_MOUSE = {{ charts.mouse|safe }};
const DISP_KEYBOARD = {{ charts.keyboard|safe }};
const DISP_UPS = {{ charts.ups|safe }};
const DISPOSED_BY_CAT_LABELS = {{ charts.disposed_by_cat_labels|safe }};
const DISPOSED_BY_CAT_DATA = {{ charts.disposed_by_cat_data|safe }};
const ACTIVE_VS_DISPOSED_LABELS = {{ charts.stack_labels|safe }};
const ACTIVE_COUNTS = {{ charts.stack_active|safe }};
const DISPOSED_COUNTS = {{ charts.stack_disposed|safe }};
const BRAND_LABELS = {{ charts.brand_labels|safe }};
const BRAND_DATA = {{ charts.brand_data|safe }};
const SECTION_LABELS = {{ charts.section_labels|safe }};
const SECTION_DATA = {{ charts.section_data|safe }};

// ========= Initialize Charts =========
(function() {
  // 1. Disposal Trend Line Chart (Styled like reference)
  var disposalCanvas = document.getElementById('disposalTrendChart');
  if (disposalCanvas) {
    var disposalCtx = disposalCanvas.getContext('2d');
    
    var myDisposalChart = new Chart(disposalCtx, {
      type: 'line',
      data: {
        labels: DISP_LABELS,
        datasets: [
          {
            label: 'Desktop',
            borderColor: '#1d7af3',
            pointBorderColor: '#FFF',
            pointBackgroundColor: '#1d7af3',
            pointBorderWidth: 2,
            pointHoverRadius: 4,
            pointHoverBorderWidth: 1,
            pointRadius: 4,
            backgroundColor: 'transparent',
            fill: true,
            tension: 0.4,  // ✅ this line makes it curve
            borderWidth: 2,
            data: DISP_DESKTOP
          },
          {
            label: 'Mouse',
            borderColor: '#59d05d',
            pointBorderColor: '#FFF',
            pointBackgroundColor: '#59d05d',
            pointBorderWidth: 2,
            pointHoverRadius: 4,
            pointHoverBorderWidth: 1,
            pointRadius: 4,
            backgroundColor: 'transparent',
            fill: true,
            borderWidth: 2,
            data: DISP_MOUSE
          },
          {
            label: 'Keyboard',
            borderColor: '#f3545d',
            pointBorderColor: '#FFF',
            pointBackgroundColor: '#f3545d',
            pointBorderWidth: 2,
            pointHoverRadius: 4,
            pointHoverBorderWidth: 1,
            pointRadius: 4,
            backgroundColor: 'transparent',
            fill: true,
            borderWidth: 2,
            data: DISP_KEYBOARD
          },
          {
            label: 'UPS',
            borderColor: '#fdaf4b',
            pointBorderColor: '#FFF',
            pointBackgroundColor: '#fdaf4b',
            pointBorderWidth: 2,
            pointHoverRadius: 4,
            pointHoverBorderWidth: 1,
            pointRadius: 4,
            backgroundColor: 'transparent',
            fill: true,
            borderWidth: 2,
            data: DISP_UPS
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          position: 'bottom',
          labels: {
            padding: 10,
            fontColor: '#1d7af3'
          }
        },
        tooltips: {
          bodySpacing: 4,
          mode: 'nearest',
          intersect: 0,
          position: 'nearest',
          xPadding: 10,
          yPadding: 10,
          caretPadding: 10
        },
        layout: {
          padding: { left: 15, right: 15, top: 15, bottom: 15 }
        },
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              stepSize: 5
            }
          }]
        }
      }
    });
  }

  // 2. Disposed by Category Pie Chart
  var pieCanvas = document.getElementById('disposedByCategoryChart');
  if (pieCanvas) {
    var pieCtx = pieCanvas.getContext('2d');
    
    var myPieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        datasets: [{
          data: DISPOSED_BY_CAT_DATA,
          backgroundColor: ['#1d7af3', '#f3545d', '#fdaf4b', '#59d05d', '#716aca'],
          borderWidth: 0
        }],
        labels: DISPOSED_BY_CAT_LABELS
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          position: 'bottom',
          labels: {
            fontColor: 'rgb(154, 154, 154)',
            fontSize: 11,
            usePointStyle: true,
            padding: 20
          }
        },
        pieceLabel: {
          render: 'percentage',
          fontColor: 'white',
          fontSize: 14
        },
        tooltips: false,
        layout: {
          padding: {
            left: 20,
            right: 20,
            top: 20,
            bottom: 20
          }
        }
      }
    });
  }

  // 3. Active vs Disposed Stacked Bar Chart
  var stackedCanvas = document.getElementById('activeDisposedStacked');
  if (stackedCanvas) {
    var stackedCtx = stackedCanvas.getContext('2d');
    
    var myStackedChart = new Chart(stackedCtx, {
      type: 'bar',
      data: {
        labels: ACTIVE_VS_DISPOSED_LABELS,
        datasets: [
          {
            label: 'Active',
            backgroundColor: '#59d05d',
            borderColor: '#59d05d',
            data: ACTIVE_COUNTS
          },
          {
            label: 'Disposed',
            backgroundColor: '#f3545d',
            borderColor: '#f3545d',
            data: DISPOSED_COUNTS
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          position: 'bottom'
        },
        title: {
          display: false
        },
        tooltips: {
          mode: 'index',
          intersect: false
        },
        scales: {
          xAxes: [{
            stacked: true
          }],
          yAxes: [{
            stacked: true,
            ticks: {
              beginAtZero: true,
              stepSize: 5
            }
          }]
        }
      }
    });
  }

  // 4. Top 5 Brands Bar Chart
  var brandCanvas = document.getElementById('brandChart');
  if (brandCanvas) {
    var brandCtx = brandCanvas.getContext('2d');
    
    var myBrandChart = new Chart(brandCtx, {
      type: 'bar',
      data: {
        labels: BRAND_LABELS,
        datasets: [{
          label: 'Assets',
          backgroundColor: 'rgb(23, 125, 255)',
          borderColor: 'rgb(23, 125, 255)',
          data: BRAND_DATA
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          display: false
        },
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              stepSize: 5
            }
          }]
        }
      }
    });
  }

  // 5. Assets by Section Horizontal Bar Chart
  var sectionCanvas = document.getElementById('sectionChart');
  if (sectionCanvas) {
    var sectionCtx = sectionCanvas.getContext('2d');
    
    var mySectionChart = new Chart(sectionCtx, {
      type: 'horizontalBar',
      data: {
        labels: SECTION_LABELS,
        datasets: [{
          label: 'Assets',
          backgroundColor: '#59d05d',
          borderColor: '#59d05d',
          data: SECTION_DATA
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          display: false
        },
        scales: {
          xAxes: [{
            ticks: {
              beginAtZero: true,
              stepSize: 5
            }
          }]
        }
      }
    });
  }
})();
</script>
{% endblock %}