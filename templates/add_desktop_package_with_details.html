<!-- templates/add_desktop_package_with_details.html -->
{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container">
  <div class="page-inner">
    <div class="page-header">
      <h3 class="fw-bold mb-3">Forms</h3>
      <ul class="breadcrumbs mb-3">
        <li class="nav-home"><a href="#"><i class="icon-home"></i></a></li>
        <li class="separator"><i class="icon-arrow-right"></i></li>
        <li class="nav-item"><a href="#">Forms</a></li>
        <li class="separator"><i class="icon-arrow-right"></i></li>
        <li class="nav-item"><a href="#">Basic Form</a></li>
      </ul>
    </div>

    <!-- Main Form -->
    <form method="post" action="{% url 'add_desktop_package_with_details' %}" id="addEquipmentForm">

      {% csrf_token %}


    

      <!-- Equipment Selection -->
      <div class="card mb-3">
        <div class="card-header"><h5>Select Equipment Type</h5></div>
        <div class="card-body">
          <select class="form-select" id="equipmentSelect" name="name_input" required>
            <option value="" disabled {% if not equipment_type %}selected{% endif %}>Select Equipment Type</option>
            <option value="Desktop" {% if equipment_type == "Desktop" %}selected{% endif %}>üñ• Desktop</option>
            <option value="Laptop" {% if equipment_type == "Laptop" %}selected{% endif %}>üíª Laptop</option>
            <option value="UPS" {% if equipment_type == "UPS" %}selected{% endif %}>üîå UPS</option>
            <!-- Later, if you rename UPS to Printer, just change this line: -->
            <!-- <option value="Printer" {% if equipment_type == "Printer" %}selected{% endif %}>üñ® Printer</option> -->
          </select>
        </div>
      </div>


     <!-- =================== DESKTOP =================== -->
<div id="desktopForm" class="equipment-form" style="display:none;">

  <!-- Desktop Info -->
  <div class="card mb-3">
    <div class="card-header"><h5>üñ• Desktop Info</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <label>Serial Number</label>
          <input type="text" name="desktop_serial_no" id="desktop_serial_no" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label>Brand</label>
          <select name="desktop_brand_name" class="form-select" required>
            <option value="">-- Select Brand --</option>
            {% for brand in desktop_brands %}
              <option value="{{ brand.id }}">{{ brand.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label>Model</label>
          <input type="text" name="desktop_model" class="form-control" required>
        </div>
      </div>
    </div>
  </div>

  <!-- Processor & Specs -->
  <div class="card mb-3">
    <div class="card-header"><h5>‚ö° Processor & Specs</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <label>Processor</label>
          <select class="form-select" id="desktop_processor" name="desktop_processor" required>
             <option value="" disabled selected>-- Select Processor --</option>
            <optgroup label="Core i9">
              <option value="i9-14900K">Core i9-14900K (14th Gen)</option>
              <option value="i9-13900K">Core i9-13900K (13th Gen)</option>
              <option value="i9-12900K">Core i9-12900K (12th Gen)</option>
            </optgroup>
            <optgroup label="Core i7">
              <option value="i7-14700K">Core i7-14700K (14th Gen)</option>
              <option value="i7-13700K">Core i7-13700K (13th Gen)</option>
            </optgroup>
            <optgroup label="Core i5">
              <option value="i5-14600K">Core i5-14600K (14th Gen)</option>
              <option value="i5-13600K">Core i5-13600K (13th Gen)</option>
            </optgroup>
          </select>
        </div>
        <div class="col-md-4">
          <label>Memory</label>
          <input type="text" name="desktop_memory" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label>Drive</label>
          <input type="text" name="desktop_drive" class="form-control" required>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-md-4">
          <label>Graphics Name</label>
          <input type="text" name="desktop_Graphics" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label>Graphics Size</label>
          <input type="text" name="desktop_Graphics_Size" class="form-control" required>
        </div>
      </div>
    </div>
  </div>

  <!-- Software -->
  <div class="card mb-3">
    <div class="card-header"><h5>‚öô Software</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3"><label>Operating System</label><input type="text" name="desktop_OS" class="form-control" required></div>
        <div class="col-md-3"><label>Office Version</label><input type="text" name="desktop_Office" class="form-control" required></div>
        <div class="col-md-3"><label>OS Keys</label><input type="text" name="desktop_OS_keys" class="form-control" required></div>
        <div class="col-md-3"><label>Office Keys</label><input type="text" name="desktop_Office_keys" class="form-control" required></div>
      </div>
    </div>
  </div>

  <!-- Monitor -->
  <div class="card mb-3">
    <div class="card-header"><h5>üñ• Monitor</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3"><label>Serial No</label><input type="text" id="monitor_sn_db" name="monitor_sn_db" class="form-control" required></div>
        <div class="col-md-3">
          <label>Brand</label>
          <select name="monitor_brand" class="form-select" required>
            <option value="">-- Select Brand --</option>
            {% for brand in monitor_brands %}
              <option value="{{ brand.id }}">{{ brand.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3"><label>Model</label><input type="text" name="monitor_model" class="form-control" required></div>
        <div class="col-md-3"><label>Size</label><input type="text" name="monitor_size" class="form-control" required></div>
      </div>
    </div>
  </div>

  <!-- Keyboard -->
  <div class="card mb-3">
    <div class="card-header"><h5>‚å® Keyboard</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4"><label>Serial No</label><input type="text" id="keyboard_sn_db" name="keyboard_sn_db" class="form-control" required></div>
        <div class="col-md-4">
          <label>Brand</label>
          <select name="keyboard_brand" class="form-select" required>
            <option value="">-- Select Brand --</option>
            {% for brand in keyboard_brands %}
              <option value="{{ brand.id }}">{{ brand.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4"><label>Model</label><input type="text" name="keyboard_model" class="form-control" required></div>
      </div>
    </div>
  </div>

  <!-- Mouse -->
  <div class="card mb-3">
    <div class="card-header"><h5>üñ± Mouse</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4"><label>Serial No</label><input type="text" id="mouse_sn_db" name="mouse_sn_db" class="form-control" required></div>
        <div class="col-md-4">
          <label>Brand</label>
          <select name="mouse_brand" class="form-select" required>
            <option value="">-- Select Brand --</option>
            {% for brand in mouse_brands %}
              <option value="{{ brand.id }}">{{ brand.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4"><label>Model</label><input type="text" name="mouse_model" class="form-control" required></div>
      </div>
    </div>
  </div>

  <!-- UPS -->
  <div class="card mb-3">
    <div class="card-header"><h5>üîå UPS</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3"><label>Serial No</label><input type="text" id="ups_sn_db" name="ups_sn_db" class="form-control" required></div>
        <div class="col-md-3">
          <label>Brand</label>
          <select name="ups_brand" class="form-select" required>
            <option value="">-- Select Brand --</option>
            {% for brand in ups_brands %}
              <option value="{{ brand.id }}">{{ brand.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3"><label>Model</label><input type="text" name="ups_model" class="form-control" required></div>
        <div class="col-md-3"><label>Capacity</label><input type="text" name="ups_capacity" class="form-control" required></div>
      </div>
    </div>
  </div>

  <!-- Documents -->
  <div class="card mb-3">
    <div class="card-header"><h5>üìë Documents</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4"><label>PAR</label><input type="text" name="par_number_input" class="form-control" required></div>
        <div class="col-md-4"><label>Property No</label><input type="text" name="property_number_input" class="form-control" required></div>
        <div class="col-md-4"><label>Acquisition Type</label><input type="text" name="acquisition_type_input" class="form-control" required></div>
      </div>
      <div class="row mt-2">
        <div class="col-md-4"><label>Value</label><input type="text" name="value_desktop_input" class="form-control" required></div>
        <div class="col-md-4"><label>Date Received</label><input type="date" name="date_received_input" class="form-control" required></div>
        <div class="col-md-4"><label>Date Inspected</label><input type="date" name="date_inspected_input" class="form-control" required></div>
      </div>
      <div class="row mt-2">
        <div class="col-md-4"><label>Supplier</label><input type="text" name="supplier_name_input" class="form-control" required></div>
        <div class="col-md-4"><label>Status</label><input type="text" name="status_desktop_input" class="form-control" required></div>
        <div class="col-md-4"><label>Computer Name</label><input type="text" name="computer_name_input" class="form-control" required></div>
      </div>
    </div>
  </div>

  <!-- User Assignment -->
  <div class="card mb-3">
    <div class="card-header"><h5>üë§ User Assignment</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <label>End User</label>
          <select name="enduser_input" class="form-select" required>
            <option value="">Select End User</option>
            {% for emp in employees %}
              <option value="{{ emp.id }}">{{ emp.full_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label>Asset Owner</label>
          <select name="assetowner_input" class="form-select" required>
            <option value="">Select Asset Owner</option>
            {% for emp in employees %}
              <option value="{{ emp.id }}">{{ emp.full_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>
</div>


   <!--  ======== LAPTOP =================== -->
<div id="laptopForm" class="equipment-form" style="display:none;">
  <!-- Laptop Info -->
  <div class="card mb-3">
    <div class="card-header"><h5>üíª Laptop Info</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <label>Serial Number</label>
          <input type="text" id="laptop_sn_db" name="laptop_sn_db" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label>Brand</label>
          <select name="laptop_brand_name" class="form-select" required>
            <option value="">-- Select Brand --</option>
            {% for brand in laptop_brands %}
              <option value="{{ brand.id }}">{{ brand.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label>Model</label>
          <input type="text" name="laptop_model" class="form-control" required>
        </div>
      </div>



      
      <!-- ‚úÖ Added Processor, Memory, Drive -->
      <div class="row mt-2">
        <div class="col-md-4">
          <label>Processor</label>
          <input type="text" name="laptop_processor" class="form-control">
        </div>
        <div class="col-md-4">
          <label>Memory (RAM)</label>
          <input type="text" name="laptop_memory" class="form-control">
        </div>
        <div class="col-md-4">
          <label>Drive</label>
          <input type="text" name="laptop_drive" class="form-control">
        </div>
      </div>
    </div>
  </div>
  
  

  <!-- Laptop Software -->
  <div class="card mb-3">
    <div class="card-header"><h5>‚öô Software</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6"><label>Operating System</label><input type="text" name="laptop_OS" class="form-control"></div>
        <div class="col-md-6"><label>OS Key</label><input type="text" name="laptop_OS_keys" class="form-control"></div>
      </div>
      <div class="row mt-2">
        <div class="col-md-6"><label>Office</label><input type="text" name="laptop_Office" class="form-control"></div>
        <div class="col-md-6"><label>Office Key</label><input type="text" name="laptop_Office_keys" class="form-control"></div>
      </div>
    </div>
  </div>

  <!-- Laptop Documents -->
  <div class="card mb-3">
    <div class="card-header"><h5>üìë Documents</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4"><label>PAR</label><input type="text" name="par_number_input" class="form-control" required></div>
        <div class="col-md-4"><label>Property No</label><input type="text" name="property_number_input" class="form-control" required></div>
        <div class="col-md-4"><label>Acquisition Type</label><input type="text" name="acquisition_type_input" class="form-control" required></div>
      </div>
      <div class="row mt-2">
        <div class="col-md-4"><label>Value</label><input type="text" name="value_laptop_input" class="form-control" required></div>
        <div class="col-md-4"><label>Date Received</label><input type="date" name="date_received_input" class="form-control" required></div>
        <div class="col-md-4"><label>Date Inspected</label><input type="date" name="date_inspected_input" class="form-control" required></div>
      </div>
      <div class="row mt-2">
        <div class="col-md-4"><label>Supplier</label><input type="text" name="supplier_name_input" class="form-control" required></div>
        <div class="col-md-4"><label>Status</label><input type="text" name="status_laptop_input" class="form-control" required></div>
        <div class="col-md-4"><label>Computer Name</label><input type="text" name="laptop_computer_name" class="form-control" required></div>
      </div>
    </div>
  </div>

  <!-- Laptop User -->
  <div class="card mb-3">
    <div class="card-header"><h5>üë§ User Assignment</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <label>End User</label>
          <select name="enduser_input" class="form-select" required>
            <option value="">Select End User</option>
            {% for emp in employees %}
              <option value="{{ emp.id }}">{{ emp.full_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label>Asset Owner</label>
          <select name="assetowner_input" class="form-select" required>
            <option value="">Select Asset Owner</option>
            {% for emp in employees %}
              <option value="{{ emp.id }}">{{ emp.full_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

      {% comment %} <!-- =================== UPS ONLY =================== -->
      <div id="upsForm" class="equipment-form" style="display:none;">
        <div class="card mb-3">
          <div class="card-header"><h5>üîå Printer Only</h5></div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3"><label>Serial</label><input type="text" name="ups_sn_db" class="form-control"></div>
              <div class="col-md-3">
                <label>Brand</label>
                <select name="ups_brand" class="form-select">
                  <option value="">-- Select Brand --</option>
                  {% for brand in ups_brands %}
                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3"><label>Model</label><input type="text" name="ups_model" class="form-control"></div>
              <div class="col-md-3"><label>Capacity</label><input type="text" name="ups_capacity" class="form-control"></div>
            </div>
          </div>
        </div>
      </div> {% endcomment %}

      <!-- Submit -->
      <div class="text-end mt-3">
        <button type="submit" class="btn btn-success"><i class="fas fa-save me-1"></i> Submit</button>
      </div>
    </form>
  </div>
</div><script src="{% static 'js/core/jquery-3.7.1.min.js' %}"></script>

<script>
$(function () {
  const $form = $("#addEquipmentForm");

  // üîπ Helper: show alert
  function showAlert(errors) {
    $(".alert-validation").remove();
    if (errors.length > 0) {
      let alertBox = $(`
        <div class="alert alert-danger alert-dismissible fade show mt-2 alert-validation">
          <strong>‚ùå Please fix the following:</strong>
          <ul class="mb-0">${errors.map(err => `<li>${err}</li>`).join("")}</ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `);
      $form.prepend(alertBox);
      $form[0].scrollIntoView({ behavior: "smooth" });
    }
  }

  // üîπ Helper: duplicate checker
  function attachDuplicateChecker(selector, category) {
    const $input = $(selector);
    if (!$input.length) return;

    function notify(msg, type) {
      if ($.notify) {
        $.notify({ message: msg }, { type: type || "danger" });
      } else {
        alert(msg);
      }
    }

    function normalize(v) { return (v || "").trim(); }

    function checkOnce() {
      const val = normalize($input.val());
      if (!val) {
        $input.removeClass("is-invalid is-valid");
        return Promise.resolve(false);
      }
      return $.get("{% url 'check_serial_no' %}", { serial: val, category: category })
        .then(function (data) {
          const dup = !!(data && data.exists);
          if (dup) {
            $input.addClass("is-invalid").removeClass("is-valid");
            notify(`‚ùå ${category} SN '${val}' already exists.`, "danger");
          } else {
            $input.addClass("is-valid").removeClass("is-invalid");
          }
          return dup;
        })
        .catch(() => false);
    }

    $input.on("blur", () => checkOnce());
    return checkOnce;
  }

  // Attach duplicate checkers
  const dupCheckers = [
    attachDuplicateChecker("#desktop_serial_no", "Desktop"),
    attachDuplicateChecker("#monitor_sn_db", "Monitor"),
    attachDuplicateChecker("#keyboard_sn_db", "Keyboard"),
    attachDuplicateChecker("#mouse_sn_db", "Mouse"),
    attachDuplicateChecker("#ups_sn_db", "UPS"),
    attachDuplicateChecker("#laptop_sn_db", "Laptop"),
  ].filter(fn => fn);

  // üîπ Unified submit handler
  $form.on("submit", function (e) {
    e.preventDefault();

    Promise.all(dupCheckers.map(fn => fn())).then(results => {
      if (results.includes(true)) {
        return; // block on duplicate
      }

      let errors = [];
      const activeForm = document.querySelector(".equipment-form[style*='block']");
      if (activeForm) {
        activeForm.querySelectorAll("input[required], select[required]").forEach(el => {
          if (!el.value || el.value.trim() === "") {
            let label = el.closest(".col-md-4, .col-md-3, .col-md-6")?.querySelector("label");
            let fieldName = label ? label.innerText : el.name;
            errors.push(fieldName + " is required.");
            el.classList.add("is-invalid");
          } else {
            el.classList.remove("is-invalid");
          }
        });
      }

      if (errors.length > 0) {
        showAlert(errors);
        return;
      }

      // ‚úÖ All good ‚Üí submit for real
      $form.off("submit");
      $form.trigger("submit");
    });
  });

  // üîπ Toggle equipment forms
  $("#equipmentSelect").on("change", function () {
    // Hide & disable everything first
    $(".equipment-form")
      .hide()
      .find("input, select, textarea")
      .prop("disabled", true)
      .prop("required", false);

    if (this.value === "Desktop") {
      const form = $("#desktopForm").show();
      form.find("input, select, textarea").prop("disabled", false);

      // mark Desktop requireds
      form.find("[name=desktop_serial_no],[name=desktop_brand_name],[name=desktop_model],[name=desktop_processor],[name=desktop_memory],[name=desktop_drive],[name=computer_name_input]").prop("required", true);
      form.find("[name=monitor_sn_db],[name=monitor_brand],[name=monitor_model],[name=monitor_size]").prop("required", true);
      form.find("[name=keyboard_sn_db],[name=keyboard_brand],[name=keyboard_model]").prop("required", true);
      form.find("[name=mouse_sn_db],[name=mouse_brand],[name=mouse_model]").prop("required", true);
      form.find("[name=ups_sn_db],[name=ups_brand],[name=ups_model],[name=ups_capacity]").prop("required", true);
      form.find("[name=par_number_input],[name=property_number_input],[name=acquisition_type_input],[name=value_desktop_input],[name=date_received_input],[name=date_inspected_input],[name=supplier_name_input],[name=status_desktop_input]").prop("required", true);
      form.find("[name=enduser_input],[name=assetowner_input]").prop("required", true);
    }

    if (this.value === "Laptop") {
      const form = $("#laptopForm").show();
      form.find("input, select, textarea").prop("disabled", false);

      // ‚úÖ only enforce Laptop fields required by backend
      form.find("[name=laptop_sn_db],[name=laptop_brand_name],[name=laptop_model],[name=laptop_computer_name]").prop("required", true);
      form.find("[name=par_number_input],[name=property_number_input],[name=acquisition_type_input],[name=value_laptop_input],[name=date_received_input],[name=date_inspected_input],[name=supplier_name_input],[name=status_laptop_input]").prop("required", true);
      form.find("[name=enduser_input],[name=assetowner_input]").prop("required", true);
    }

    if (this.value === "Printer") {
      const form = $("#upsForm").show();
      form.find("input, select, textarea").prop("disabled", false).prop("required", true);
    }
  });

  // üîπ Initialize state on load
  $("#equipmentSelect").trigger("change");
});
</script>



{% endblock %}
