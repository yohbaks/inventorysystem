{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <div class="row g-4">
      <!-- Left: Avatar + quick info -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <img src="{{ profile.avatar_url }}" alt="avatar" class="rounded-circle mb-3" width="120" height="120" style="object-fit:cover;">
            <h5 class="mb-0">{{ request.user.get_full_name|default:request.user.username }}</h5>
            <p class="text-muted mb-2">{{ request.user.email|default:"hello@example.com" }}</p>

            <form method="post" action="{% url 'update_profile' %}" enctype="multipart/form-data" class="mt-3">
              {% csrf_token %}
              <div class="mb-2">
                <input type="file" name="avatar" accept="image/*" class="form-control">
              </div>
              <button class="btn btn-outline-primary btn-sm" type="submit">Update Avatar</button>
            </form>

            <hr>
            <div class="text-start small">
              <div><strong>Theme:</strong> {{ profile.theme|title }}</div>
              <div><strong>Timezone:</strong> {{ profile.timezone_str }}</div>
              <div><strong>PM Notifications:</strong> {{ profile.notify_pm_due|yesno:"On,Off" }}</div>
              {% if profile.office_section %}<div><strong>Section:</strong> {{ profile.office_section.name }}</div>{% endif %}
              {% if profile.employee %}<div><strong>Employee Link:</strong> {{ profile.employee.full_name }}</div>{% endif %}
              <div><strong>Last login:</strong> {{ request.user.last_login|date:"Y-m-d H:i" }}</div>
              <div><strong>Joined:</strong> {{ request.user.date_joined|date:"Y-m-d" }}</div>
            </div>
            <hr>
<div class="text-center">
  <h6 class="mb-2">Scan to view my assets</h6>
  {% if profile.qr_code %}
    <img src="{{ profile.qr_code.url }}" alt="User QR" width="180" height="180" class="rounded" />
  {% else %}
    <div class="text-muted small">QR will appear after refresh.</div>
  {% endif %}
  <div class="mt-2">
    <a href="{% url 'user_assets_public' profile.qr_token %}" class="btn btn-outline-secondary btn-sm">
      Open QR Link
    </a>
    <a href="{% url 'regenerate_user_qr' %}" class="btn btn-outline-danger btn-sm ms-1">
      Regenerate
    </a>
  </div>
</div>

          </div>
        </div>
      </div>

      <!-- Right: Edit Profile & Security -->
      <div class="col-md-8">
        <div class="card shadow-sm mb-4">
          <div class="card-header"><h5 class="mb-0">Edit Profile</h5></div>
          <div class="card-body">
            <form method="post" action="{% url 'update_profile' %}" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">First Name</label>
                  <input class="form-control" name="first_name" value="{{ request.user.first_name }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Last Name</label>
                  <input class="form-control" name="last_name" value="{{ request.user.last_name }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" name="email" value="{{ request.user.email }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Phone</label>
                  <input class="form-control" name="phone" value="{{ profile.phone }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Position</label>
                  <input class="form-control" name="position" value="{{ profile.position }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Office Section</label>
                  <select class="form-select" name="office_section_id">
                    <option value="">—</option>
                    {% for s in sections %}
                      <option value="{{ s.id }}" {% if profile.office_section and profile.office_section.id == s.id %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Link to Employee</label>
                  <select class="form-select" name="employee_id">
                    <option value="">—</option>
                    {% for e in employees %}
                      <option value="{{ e.id }}" {% if profile.employee and profile.employee.id == e.id %}selected{% endif %}>{{ e.full_name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Theme</label>
                  <select class="form-select" name="theme">
                    <option value="light" {% if profile.theme == "light" %}selected{% endif %}>Light</option>
                    <option value="dark" {% if profile.theme == "dark" %}selected{% endif %}>Dark</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Timezone</label>
                  <input class="form-control" name="timezone_str" value="{{ profile.timezone_str }}">
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="notify_pm_due" id="notify" {% if profile.notify_pm_due %}checked{% endif %}>
                    <label for="notify" class="form-check-label">Email me PM due reminders</label>
                  </div>
                </div>
              </div>
              <div class="mt-3 d-flex gap-2">
                <button class="btn btn-primary" type="submit">Save Changes</button>
                <a class="btn btn-outline-secondary" href="{% url 'profile' %}">Cancel</a>
              </div>
            </form>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header"><h5 class="mb-0">Security</h5></div>
          <div class="card-body">
            <form method="post" action="{% url 'change_password' %}">
              {% csrf_token %}
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Current Password</label>
                  <input type="password" class="form-control" name="current_password" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">New Password</label>
                  <input type="password" class="form-control" name="new_password1" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Confirm New Password</label>
                  <input type="password" class="form-control" name="new_password2" required>
                </div>
              </div>
              <div class="mt-3">
                <button class="btn btn-warning" type="submit">Change Password</button>
              </div>
            </form>
          </div>
        </div>

        {% if assigned_packages %}
        <div class="card shadow-sm mt-4">
          <div class="card-header"><h5 class="mb-0">My Assigned Equipment</h5></div>
          <div class="card-body table-responsive">
            <table class="table table-bordered table-hover">
              <thead>
                <tr><th>Package</th><th>Computer Name</th><th>Status</th></tr>
              </thead>
              <tbody>
                {% for dp in assigned_packages %}
                {% with dd=dp.desktop_details.first %}
                <tr>
                  <td>#{{ dp.id }}</td>
                  <td>
                    {% if dd %}
                        {{ dd.computer_name }}
                    {% else %}
                        —
                    {% endif %}
                    </td>
                  <td>{% if dd and not dd.is_disposed %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-danger">Disposed</span>{% endif %}</td>
                </tr>
                {% endwith %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>
{% endblock %}
