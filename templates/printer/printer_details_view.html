{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <div class="page-inner py-4">
    <div class="card card-round shadow-sm animated fadeIn border-0">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <i class="fa fa-print me-2 fs-4"></i>
          <h4 class="card-title mb-0 fw-semibold">Printer Details</h4>
        </div>
        <div>
          <a href="{% url 'printer_list' %}" class="btn btn-light btn-sm shadow-sm">
            <i class="fa fa-arrow-left me-1"></i> Back to List
          </a>
        </div>
      </div>

      <div class="card-body">
        <div class="row g-3">
          <!-- LEFT COLUMN -->
          <div class="col-md-7">

            <!-- Printer Info -->
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-header bg-light border-bottom">
                <h5 class="fw-bold text-primary mb-0">
                  <i class="fa fa-info-circle me-2 text-primary"></i> Printer Information
                </h5>
              </div>
              <div class="card-body">
                <table class="table table-borderless mb-0">
                  <tbody>
                    <tr><th style="width:35%">Serial Number</th><td><span class="badge bg-secondary">{{ printer.printer_sn_db }}</span></td></tr>
                    <tr><th>Brand</th><td>{{ printer.printer_brand_db|default:"—" }}</td></tr>
                    <tr><th>Model</th><td>{{ printer.printer_model_db|default:"—" }}</td></tr>
                    <tr><th>Type</th><td>{{ printer.printer_type|default:"—" }}</td></tr>
                    <tr><th>Resolution</th><td>{{ printer.printer_resolution|default:"—" }}</td></tr>
                    <tr><th>Monthly Duty</th><td>{{ printer.printer_monthly_duty|default:"—" }}</td></tr>
                    <tr>
                      <th>Color</th>
                      <td>
                        {% if printer.printer_color %}
                          <span class="badge bg-success">Color</span>
                        {% else %}
                          <span class="badge bg-dark">Monochrome</span>
                        {% endif %}
                      </td>
                    </tr>
                    <tr>
                      <th>Duplex</th>
                      <td>
                        {% if printer.printer_duplex %}
                          <i class="fa fa-check-circle text-success"></i> Supported
                        {% else %}
                          <i class="fa fa-times-circle text-danger"></i> Not Supported
                        {% endif %}
                      </td>
                    </tr>
                    <tr><th>Package</th><td>{{ printer.equipment_package.id }}</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Documents Details -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-light border-bottom">
                    <h5 class="fw-bold text-primary mb-0">
                    <i class="fa fa-file-alt me-2 text-primary"></i> Documents
                    </h5>
                </div>
                <div class="card-body">
                    {% if docs_details %}
                    <table class="table table-borderless mb-0">
                    <tbody>
                        <tr><th style="width:35%">PAR</th><td>{{ docs_details.docs_PAR|default:"—" }}</td></tr>
                        <tr><th>Property No.</th><td>{{ docs_details.docs_Propertyno|default:"—" }}</td></tr>
                        <tr><th>Acquisition Type</th><td>{{ docs_details.docs_Acquisition_Type|default:"—" }}</td></tr>
                        <tr><th>Value</th><td>₱ {{ docs_details.docs_Value|default:"—" }}</td></tr>
                        <tr><th>Date Received</th><td>{{ docs_details.docs_Datereceived|default:"—" }}</td></tr>
                        <tr><th>Date Inspected</th><td>{{ docs_details.docs_Dateinspected|default:"—" }}</td></tr>
                        <tr><th>Supplier</th><td>{{ docs_details.docs_Supplier|default:"—" }}</td></tr>
                        <tr><th>Status</th><td>{{ docs_details.docs_Status|default:"—" }}</td></tr>
                    </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-warning mb-0 text-center">No document details found for this package.</div>
                    {% endif %}
                </div>
            </div>

          </div>

          <!-- RIGHT COLUMN -->
          <div class="col-md-5">

            <!-- User Assignment -->
            <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-light border-bottom">
                <h5 class="fw-bold text-primary mb-0">
                <i class="fa fa-user me-2 text-primary"></i> User Assignment
                </h5>
            </div>
            <div class="card-body">
                {% if user_details %}
                <table class="table table-borderless mb-0">
                <tbody>
                    <tr>
                    <th style="width:40%">End User</th>
                    <td>{{ user_details.user_Enduser.full_name|default:"—" }}</td>
                    </tr>
                    <tr>
                    <th>Asset Owner</th>
                    <td>{{ user_details.user_Assetowner.full_name|default:"—" }}</td>
                    </tr>
                </tbody>
                </table>
                {% else %}
                <div class="alert alert-warning mb-0 text-center">No user assignment found for this package.</div>
                {% endif %}
            </div>
            </div>

            <!-- Status & Actions -->
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-header bg-light border-bottom">
                <h5 class="fw-bold text-primary mb-0">
                  <i class="fa fa-cogs me-2 text-primary"></i> Status & Actions
                </h5>
              </div>
              <div class="card-body">
                {% if printer.is_disposed %}
                  <div class="alert alert-danger text-center">
                    <i class="fa fa-ban me-1"></i> This printer has been <strong>disposed</strong>.
                  </div>
                {% else %}
                  <div class="alert alert-info text-center">
                    <i class="fa fa-info-circle me-1"></i> This printer is currently active.
                  </div>
                  <button
                    class="btn btn-danger w-100 mt-2"
                    data-bs-toggle="modal"
                    data-bs-target="#disposePrinterModal">
                    <i class="fa fa-trash me-1"></i> Dispose Printer
                  </button>
                {% endif %}
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Disposal History -->
    {% if disposed_printers %}
    <div class="row mt-3">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-light border-bottom">
            <h5 class="fw-bold text-danger mb-0">
              <i class="fa fa-history me-2"></i> Disposal History
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Serial</th>
                    <th>Brand</th>
                    <th>Model</th>
                    <th>Type</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody>
                  {% for disposed in disposed_printers %}
                  <tr>
                    <td>{{ disposed.disposal_date|date:"Y-m-d H:i" }}</td>
                    <td><span class="badge bg-secondary">{{ disposed.printer_sn }}</span></td>
                    <td>{{ disposed.printer_brand|default:"—" }}</td>
                    <td>{{ disposed.printer_model|default:"—" }}</td>
                    <td>{{ disposed.printer_type|default:"—" }}</td>
                    <td>{{ disposed.reason|truncatewords:15 }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

  </div>
</div>

<!-- Dispose Modal -->
<div class="modal fade" id="disposePrinterModal" tabindex="-1" aria-labelledby="disposePrinterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-3">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-semibold"><i class="fa fa-trash me-2"></i>Dispose Printer</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="disposeMessage" class="mb-3"></p>
        <form id="disposePrinterForm">
          {% csrf_token %}
          <div class="form-group mb-3">
            <label class="form-label fw-semibold">Reason for Disposal</label>
            <textarea name="reason" id="reason" class="form-control" rows="3" placeholder="Enter reason..." required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDisposeBtn">
          <i class="fa fa-check me-1"></i> Confirm Dispose
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
  <div id="disposeToast" class="toast align-items-center text-bg-success border-0 shadow" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Printer disposed successfully.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
$(document).ready(function() {
  const modalEl = document.getElementById("disposePrinterModal");
  const messageEl = document.getElementById("disposeMessage");
  const confirmBtn = document.getElementById("confirmDisposeBtn");
  const toastEl = document.getElementById("disposeToast");
  const toastMsg = document.getElementById("toastMessage");

  // Show modal message
  $(modalEl).on('show.bs.modal', function () {
    const brand = "{{ printer.printer_brand_db|default:'Unknown' }}";
    const model = "{{ printer.printer_model_db|default:'' }}";
    messageEl.innerHTML = `Are you sure you want to dispose <strong>${brand} ${model}</strong>?`;
  });

  // Confirm disposal
  confirmBtn.addEventListener("click", function() {
    const reason = document.getElementById("reason").value.trim();
    
    if (!reason) {
      alert("Please enter a reason for disposal.");
      return;
    }

    // Disable button to prevent double clicks
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Processing...';

    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    
    console.log("Sending disposal request for printer ID: {{ printer.id }}");
    
    fetch("/printers/dispose/{{ printer.id }}/", {
      method: "POST",
      headers: { 
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ reason: reason })
    })
    .then(response => {
      console.log("Response status:", response.status);
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log("Response data:", data);
      
      if (data.status === "success") {
        // Show success toast
        toastMsg.textContent = data.message;
        toastEl.classList.remove("text-bg-danger");
        toastEl.classList.add("text-bg-success");
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
        
        // Close modal
        $(modalEl).modal('hide');
        
        // Reload page after delay
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        // Show error
        toastMsg.textContent = data.message || "Failed to dispose printer.";
        toastEl.classList.remove("text-bg-success");
        toastEl.classList.add("text-bg-danger");
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
        
        // Re-enable button
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fa fa-check me-1"></i> Confirm Dispose';
      }
    })
    .catch(err => {
      console.error("Fetch error:", err);
      
      toastMsg.textContent = "An error occurred: " + err.message;
      toastEl.classList.remove("text-bg-success");
      toastEl.classList.add("text-bg-danger");
      
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
      
      // Re-enable button
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fa fa-check me-1"></i> Confirm Dispose';
    });
  });
});
</script>
{% endblock %}